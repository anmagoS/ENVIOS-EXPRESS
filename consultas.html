<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Consulta de Env√≠os - Clientes</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* Contenido principal */
        .content {
            padding: 40px;
        }
        
        /* Formulario de b√∫squeda */
        .search-section {
            margin-bottom: 40px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        #envioId {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        #envioId:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }
        
        .search-buttons {
            display: flex;
            gap: 10px;
        }
        
        #btnBuscar {
            padding: 15px 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 120px;
            justify-content: center;
        }
        
        #btnScanner {
            padding: 15px 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
            justify-content: center;
        }
        
        #btnBuscar:hover, #btnScanner:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        #btnBuscar:active, #btnScanner:active {
            transform: translateY(0);
        }
        
        .search-help {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
            border-left: 4px solid #1e3c72;
            margin-top: 15px;
        }
        
        /* Modal del esc√°ner */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .scanner-container {
            width: 90%;
            max-width: 500px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        
        .scanner-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scanner-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .scanner-content {
            padding: 20px;
            text-align: center;
        }
        
        #qr-reader {
            width: 100%;
            margin: 0 auto;
        }
        
        .scanner-instructions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .scanner-instructions ol {
            text-align: left;
            padding-left: 20px;
            margin: 10px 0;
        }
        
        .scanner-instructions li {
            margin-bottom: 8px;
        }
        
        .close-scanner {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }
        
        .scanner-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .scanner-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .scanner-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        /* Resultados */
        .results-section {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        /* Tarjeta de env√≠o */
        .envio-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .envio-header {
            padding: 25px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        
        .envio-id {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e3c72;
            font-family: 'Courier New', monospace;
        }
        
        .estado-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .estado-RECIBIDO {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .estado-REPARTO {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .estado-ENTREGADO {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .estado-NOVEDAD {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .estado-CANCELADO {
            background: #f5f5f5;
            color: #616161;
        }
        
        .envio-content {
            padding: 25px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        /* Secciones especiales */
        .payment-section, .shipping-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            color: #1e3c72;
            margin-bottom: 15px;
        }
        
        .payment-details, .shipping-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Bot√≥n de acciones */
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn-secondary {
            flex: 1;
            padding: 15px;
            background: #f8f9fa;
            color: #1e3c72;
            border: 2px solid #1e3c72;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-secondary:hover {
            background: #1e3c72;
            color: white;
        }
        
        /* Mensajes */
        .error-message {
            background: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            border-left: 4px solid #d32f2f;
        }
        
        .not-found {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .not-found h3 {
            margin-bottom: 10px;
            color: #d32f2f;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
            background: #f8f9fa;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .search-buttons {
                flex-direction: column;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .envio-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .scanner-container {
                width: 95%;
            }
        }
        
        /* Animaciones */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes scannerSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .scanner-success {
            animation: scannerSuccess 0.5s ease;
        }
        /* üÜï MODAL PARA FIRMA DE ENTREGA */
.modal-firma-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-firma-container {
  background: white;
  border-radius: 15px;
  width: 100%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: slideUp 0.3s ease;
}

.modal-firma-header {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-firma-header h3 {
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn-cerrar-modal {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 5px;
}

.modal-firma-content {
  padding: 25px;
  text-align: center;
  max-height: calc(90vh - 120px);
  overflow-y: auto;
}

.firma-imagen-container {
  margin: 20px 0;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 10px;
  background: #f8f9fa;
  max-width: 100%;
}

#imgFirmaEntrega {
  max-width: 100%;
  max-height: 400px;
  border-radius: 5px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.firma-info {
  text-align: left;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  font-size: 0.9rem;
  color: #555;
}

.firma-info h4 {
  color: #1e3c72;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.carga-firma {
  padding: 40px;
  text-align: center;
  color: #666;
}

.error-firma {
  background: #ffebee;
  color: #d32f2f;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  margin: 20px 0;
}

.btn-descargar-firma {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  margin-top: 15px;
  transition: all 0.3s;
}

.btn-descargar-firma:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
}
    </style>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-box"></i>
                Consulta de Env√≠os
            </h1>
            <p>Ingresa tu n√∫mero de gu√≠a o escan√©alo</p>
        </div>
        
        <!-- Contenido principal -->
        <div class="content">
            <!-- Formulario de b√∫squeda -->
            <div class="search-section">
                <div class="search-box">
                    <input type="text" 
                           id="envioId" 
                           placeholder="EJ: ENV2601031921520165 o MAS26010700011922275"
                           autocomplete="off"
                           autocapitalize="characters"
                           maxlength="25">
                    <div class="search-buttons">
                        <button id="btnBuscar">
                            <i class="fas fa-search"></i>
                            Consultar
                        </button>
                        <button id="btnScanner">
                            <i class="fas fa-qrcode"></i>
                            Escanear Gu√≠a
                        </button>
                    </div>
                </div>
                
                <div class="search-help">
                    <p><strong>¬øC√≥mo consultar tu env√≠o?</strong><br>
                    - Escribe manualmente el n√∫mero de gu√≠a (ej: ENV2601031921520165 o MAS26010700011922275)<br>
                    - O usa el bot√≥n "Escanear Gu√≠a" para leer el c√≥digo QR o de barras de tu gu√≠a f√≠sica
                    </p>
                </div>
            </div>
            
            <!-- Mensaje de error -->
            <div id="errorMessage" class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
            </div>
            
            <!-- Secci√≥n de carga -->
            <div id="loading" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin fa-2x pulse" style="color: #1e3c72;"></i>
                <p style="margin-top: 15px;">Buscando informaci√≥n del env√≠o...</p>
            </div>
            
            <!-- Secci√≥n de resultados -->
            <div id="resultsSection" class="results-section">
                <!-- Aqu√≠ se mostrar√°n los resultados -->
            </div>
            
            <!-- No encontrado -->
            <div id="notFound" class="not-found" style="display: none;">
                <i class="fas fa-box-open fa-3x" style="color: #ccc; margin-bottom: 20px;"></i>
                <h3>Env√≠o no encontrado</h3>
                <p>Verifica que el n√∫mero de gu√≠a sea correcto o contacta con soporte.</p>
                <button class="btn-secondary" onclick="resetSearch()" style="margin-top: 20px;">
                    <i class="fas fa-redo"></i> Nueva b√∫squeda
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>¬© 2024 Sistema de Env√≠os - Consulta en l√≠nea</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">Si tienes problemas, contacta a soporte: anmagostore@gmail.com/3006498710</p>
        </div>
    </div>
    
    <!-- Modal del Esc√°ner -->
    <div id="scannerModal" class="scanner-modal">
        <div class="scanner-container">
            <div class="scanner-header">
                <h3><i class="fas fa-qrcode"></i> Escanear Gu√≠a</h3>
                <button class="close-scanner" id="closeScanner">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="scanner-content">
                <div id="qr-reader" style="width: 100%;"></div>
                <div id="scannerStatus" class="scanner-status"></div>
                
                <div class="scanner-instructions">
                    <p><strong>Instrucciones:</strong></p>
                    <ol>
                        <li>Apunta la c√°mara hacia el c√≥digo QR o de barras de tu gu√≠a</li>
                        <li>Aseg√∫rate de que el c√≥digo est√© bien iluminado</li>
                        <li>Mant√©n la c√°mara estable hasta que se detecte el c√≥digo</li>
                        <li>El esc√°ner se cerrar√° autom√°ticamente al detectar el c√≥digo</li>
                    </ol>
                    <p style="margin-top: 10px; font-size: 0.8rem;">
                        <i class="fas fa-info-circle"></i> Tambi√©n puedes seleccionar una imagen del c√≥digo si tu c√°mara no funciona
                    </p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button id="btnFileScanner" class="btn-secondary" style="width: 100%;">
                        <i class="fas fa-image"></i> Seleccionar imagen del c√≥digo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const API_URL = 'https://script.google.com/macros/s/AKfycbxIipuPmVAvaTt7_oUQzMLNtXIah19dcq2CWkaoglQvFivqY-wBYEw64tvUmL4-1k62/exec';
        
        // Elementos del DOM
        const envioIdInput = document.getElementById('envioId');
        const btnBuscar = document.getElementById('btnBuscar');
        const btnScanner = document.getElementById('btnScanner');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('resultsSection');
        const notFound = document.getElementById('notFound');
        const scannerModal = document.getElementById('scannerModal');
        const closeScanner = document.getElementById('closeScanner');
        const scannerStatus = document.getElementById('scannerStatus');
        const btnFileScanner = document.getElementById('btnFileScanner');
        
        // Variables para el esc√°ner
        let html5QrCode = null;
        let isScanning = false;
        
        // Funci√≥n para validar el formato de la gu√≠a
        function validarFormatoGuia(envioId) {
            // Acepta ENV o MAS al inicio
            return envioId.startsWith('ENV') || envioId.startsWith('MAS');
        }
        
        // Funci√≥n para buscar env√≠o
        async function buscarEnvio() {
            const envioId = envioIdInput.value.trim().toUpperCase();
            
            // Validar entrada
            if (!envioId) {
                showError('Por favor, ingresa un n√∫mero de gu√≠a');
                envioIdInput.focus();
                return;
            }
            
            // Validar formato - ahora acepta ENV o MAS
            if (!validarFormatoGuia(envioId)) {
                showError('El n√∫mero de gu√≠a debe comenzar con "ENV" o "MAS"');
                return;
            }
            
            // Limpiar resultados anteriores
            hideAllSections();
            loading.style.display = 'block';
            
            try {
                // Llamar a la API
                const response = await fetch(`${API_URL}?action=obtenerGuia&id=${encodeURIComponent(envioId)}`);
                const data = await response.json();
                
                loading.style.display = 'none';
                
                if (data.success && data.encontrado) {
                    // Mostrar el env√≠o encontrado
                    mostrarEnvio(data);
                } else {
                    // Mostrar no encontrado
                    notFound.style.display = 'block';
                }
                
            } catch (error) {
                loading.style.display = 'none';
                showError('Error al conectar con el servidor. Intenta nuevamente.');
                console.error('Error:', error);
            }
        }
        
        // Funci√≥n para mostrar el env√≠o
       // Funci√≥n para mostrar el env√≠o
function mostrarEnvio(envio) {
  // Determinar clase CSS seg√∫n estado
  const estadoClase = `estado-${envio.ESTADO || envio.estado || 'RECIBIDO'}`;
  const estadoTexto = envio.ESTADO || envio.estado || 'RECIBIDO';
  
  // Determinar icono seg√∫n estado
  let estadoIcono = 'fa-box';
  switch(estadoTexto) {
    case 'RECIBIDO':
      estadoIcono = 'fa-inbox';
      break;
    case 'REPARTO':
      estadoIcono = 'fa-truck';
      break;
    case 'ENTREGADO':
      estadoIcono = 'fa-check-circle';
      break;
    case 'NOVEDAD':
      estadoIcono = 'fa-exclamation-triangle';
      break;
    case 'CANCELADO':
      estadoIcono = 'fa-times-circle';
      break;
  }
  
  // Formatear fecha
  const fecha = envio['FECHA DE CREACION'] || envio.fechaCreacion || 'No disponible';
  
  // Determinar estado de pago
  const pagado = envio['PAGADO A REMITENTE'] || envio.pagadoRemitente || 'NO';
  const pagoClase = pagado === 'SI' ? 'estado-ENTREGADO' : 'estado-NOVEDAD';
  const pagoTexto = pagado === 'SI' ? 'Pagado' : 'Pendiente de pago';
  
  // üÜï VERIFICAR SI HAY FIRMA DISPONIBLE
  const tieneFirma = envio.URL_FIRMA_ENTREGA && envio.URL_FIRMA_ENTREGA.trim() !== '';
  const firmaUrl = envio.URL_FIRMA_ENTREGA || '';
  
  // üÜï Informaci√≥n adicional del historial si existe
  const fechaEntrega = envio.FECHA_ENTREGA_HISTORIAL || '';
  const mensajeroHistorial = envio.MENSAJERO_HISTORIAL || '';
  const obsHistorial = envio.OBSERVACIONES_HISTORIAL || '';
  
  // Crear HTML del env√≠o
  const html = `
    <div class="envio-card">
      <div class="envio-header">
        <div class="envio-id">${envio['ENVIO ID'] || envio.id || 'Sin ID'}</div>
        <div class="estado-badge ${estadoClase}">
          <i class="fas ${estadoIcono}"></i>
          ${estadoTexto}
        </div>
      </div>
      
      <div class="envio-content">
        <!-- Informaci√≥n b√°sica -->
        <div class="info-grid">
          <div class="info-item">
            <div class="info-label">Fecha de creaci√≥n</div>
            <div class="info-value">${fecha}</div>
          </div>
          
          ${fechaEntrega ? `
          <div class="info-item">
            <div class="info-label">Fecha de entrega</div>
            <div class="info-value">${fechaEntrega}</div>
          </div>
          ` : ''}
          
          <div class="info-item">
            <div class="info-label">Forma de pago</div>
            <div class="info-value">${envio['FORMA DE PAGO'] || envio.formaPago || 'No especificado'}</div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Estado del env√≠o</div>
            <div class="info-value ${estadoClase}" style="display: inline-block; padding: 5px 10px; border-radius: 5px;">
              ${estadoTexto}
            </div>
          </div>
          
          <div class="info-item">
            <div class="info-label">Estado de pago</div>
            <div class="info-value ${pagoClase}" style="display: inline-block; padding: 5px 10px; border-radius: 5px;">
              ${pagoTexto}
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n del remitente/destinatario -->
        <div class="shipping-section">
          <div class="section-title">
            <i class="fas fa-user"></i>
            Informaci√≥n del env√≠o
          </div>
          <div class="shipping-details">
            <div class="info-item">
              <div class="info-label">Remitente</div>
              <div class="info-value">${envio.REMITE || 'No especificado'}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Destinatario</div>
              <div class="info-value">${envio.DESTINO || 'No especificado'}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Ciudad destino</div>
              <div class="info-value">${envio['CIUDAD DESTINO'] || 'No especificado'}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Mensajero asignado</div>
              <div class="info-value">${envio.MENSAJERO || 'Por asignar'}</div>
            </div>
            
            ${mensajeroHistorial ? `
            <div class="info-item">
              <div class="info-label">Mensajero que entreg√≥</div>
              <div class="info-value">${mensajeroHistorial}</div>
            </div>
            ` : ''}
          </div>
        </div>
        
        <!-- Informaci√≥n de valor -->
        <div class="payment-section">
          <div class="section-title">
            <i class="fas fa-money-bill-wave"></i>
            Informaci√≥n de valores
          </div>
          <div class="payment-details">
            <div class="info-item">
              <div class="info-label">Valor a recaudar</div>
              <div class="info-value">$${parseFloat(envio['VALOR A RECAUDAR'] || envio.valorRecaudar || 0).toLocaleString()}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Total a pagar</div>
              <div class="info-value">$${parseFloat(envio['TOTAL A PAGAR'] || envio.totalPagar || 0).toLocaleString()}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Localidad</div>
              <div class="info-value">${envio.LOCALIDAD || 'Por asignar'}</div>
            </div>
            
            <div class="info-item">
              <div class="info-label">Barrio</div>
              <div class="info-value">${envio.BARRIO || 'No especificado'}</div>
            </div>
          </div>
        </div>
        
        <!-- Observaciones -->
        ${envio.OBS ? `
        <div class="info-item">
          <div class="info-label">Observaciones</div>
          <div class="info-value">${envio.OBS}</div>
        </div>
        ` : ''}
        
        ${obsHistorial ? `
        <div class="info-item">
          <div class="info-label">Observaciones de entrega</div>
          <div class="info-value">${obsHistorial}</div>
        </div>
        ` : ''}
        
        <!-- üÜï SECCI√ìN DE COMPROBANTE DE ENTREGA -->
        ${tieneFirma ? `
        <div class="comprobante-section" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #4CAF50;">
          <div class="section-title">
            <i class="fas fa-file-signature"></i>
            Comprobante de Entrega
          </div>
          <p style="margin-bottom: 15px; color: #666;">
            Este env√≠o fue entregado con firma digital del destinatario.
          </p>
          
          <div style="text-align: center; margin: 20px 0;">
            <button id="btnVerFirma" class="btn-secondary" style="padding: 12px 24px; font-size: 16px;" onclick="mostrarModalFirma('${firmaUrl}', '${envio['ENVIO ID'] || ''}')">
              <i class="fas fa-eye"></i>
              Ver Comprobante de Entrega
            </button>
          </div>
          
          <div style="font-size: 0.9rem; color: #888; text-align: center;">
            <i class="fas fa-info-circle"></i>
            La firma fue registrada el ${fechaEntrega || 'fecha no disponible'}
          </div>
        </div>
        ` : estadoTexto === 'ENTREGADO' ? `
        <div class="info-item" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px;">
          <div class="info-label">Estado de entrega</div>
          <div class="info-value">
            <i class="fas fa-check-circle" style="color: #28a745;"></i>
            Env√≠o entregado exitosamente
            ${!tieneFirma ? '<br><small style="color: #666;">(Comprobante de firma no disponible)</small>' : ''}
          </div>
        </div>
        ` : ''}
        
        <!-- Bot√≥n de Google Maps (si existe URL) -->
        ${envio['URL DIRECCION MAPS'] ? `
        <div class="actions">
          <button class="btn-secondary" onclick="window.open('${envio['URL DIRECCION MAPS']}', '_blank')">
            <i class="fas fa-map-marker-alt"></i>
            Ver en Google Maps
          </button>
        </div>
        ` : ''}
      </div>
    </div>
    
    <div class="actions" style="margin-top: 20px;">
      <button class="btn-secondary" onclick="resetSearch()">
        <i class="fas fa-redo"></i>
        Nueva b√∫squeda
      </button>
      
      <button class="btn-secondary" onclick="imprimirEnvio()">
        <i class="fas fa-print"></i>
        Imprimir informaci√≥n
      </button>
    </div>
  `;
  
  resultsSection.innerHTML = html;
  resultsSection.style.display = 'block';
}
        
        // FUNCIONES DEL ESC√ÅNER
        
        // Abrir el esc√°ner
        function abrirScanner() {
            scannerModal.style.display = 'flex';
            iniciarScanner();
        }
        
        // Cerrar el esc√°ner
        function cerrarScanner() {
            scannerModal.style.display = 'none';
            detenerScanner();
        }
        
        // Iniciar el esc√°ner
        function iniciarScanner() {
            if (isScanning) return;
            
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };
            
            html5QrCode.start(
                { facingMode: "environment" },
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                isScanning = true;
                scannerStatus.className = 'scanner-status';
                scannerStatus.textContent = '';
            }).catch(err => {
                console.error("Error al iniciar esc√°ner:", err);
                showScannerStatus('Error al acceder a la c√°mara. Usa la opci√≥n de imagen.', 'error');
            });
        }
        
        // Detener el esc√°ner
        function detenerScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    isScanning = false;
                    html5QrCode = null;
                }).catch(err => {
                    console.error("Error al detener esc√°ner:", err);
                });
            }
        }
        
        // Cuando se escanea un c√≥digo exitosamente
        function onScanSuccess(decodedText, decodedResult) {
            // Validar que el c√≥digo escaneado sea una gu√≠a v√°lida
            const texto = decodedText.toUpperCase();
            if (decodedText && validarFormatoGuia(texto)) {
                // Agregar efecto visual de √©xito
                scannerStatus.className = 'scanner-status success';
                scannerStatus.innerHTML = `<i class="fas fa-check-circle"></i> C√≥digo detectado: ${texto}`;
                scannerStatus.classList.add('scanner-success');
                
                // Cerrar el esc√°ner despu√©s de un breve delay
                setTimeout(() => {
                    cerrarScanner();
                    
                    // Poner el c√≥digo en el input y buscar autom√°ticamente
                    envioIdInput.value = texto;
                    buscarEnvio();
                }, 1000);
            } else {
                showScannerStatus('C√≥digo no v√°lido. Busca un c√≥digo de gu√≠a que comience con "ENV" o "MAS"', 'error');
            }
        }
        
        // Cuando hay un error en el escaneo
        function onScanError(error) {
            // No mostrar errores menores
            if (!error || error === 'NotFoundException' || error.includes('No multi format readers')) {
                return;
            }
            console.warn(`Error en esc√°ner: ${error}`);
        }
        
        // Mostrar estado del esc√°ner
        function showScannerStatus(message, type) {
            scannerStatus.textContent = message;
            scannerStatus.className = `scanner-status ${type}`;
            scannerStatus.style.display = 'block';
            
            // Ocultar despu√©s de 3 segundos si es un error
            if (type === 'error') {
                setTimeout(() => {
                    scannerStatus.style.display = 'none';
                }, 3000);
            }
        }
        
        // Escanear desde archivo
        function escanearDesdeArchivo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    Html5Qrcode.getCameras().then(devices => {
                        if (devices && devices.length) {
                            const html5QrCodeFile = new Html5Qrcode("qr-reader");
                            html5QrCodeFile.scanFile(file, true)
                                .then(decodedText => {
                                    const texto = decodedText.toUpperCase();
                                    if (decodedText && validarFormatoGuia(texto)) {
                                        showScannerStatus(`<i class="fas fa-check-circle"></i> C√≥digo detectado: ${texto}`, 'success');
                                        scannerStatus.classList.add('scanner-success');
                                        
                                        setTimeout(() => {
                                            cerrarScanner();
                                            envioIdInput.value = texto;
                                            buscarEnvio();
                                        }, 1000);
                                    } else {
                                        showScannerStatus('C√≥digo no v√°lido en la imagen. Debe comenzar con ENV o MAS', 'error');
                                    }
                                })
                                .catch(err => {
                                    showScannerStatus('No se pudo leer el c√≥digo de la imagen', 'error');
                                    console.error("Error al escanear archivo:", err);
                                });
                        }
                    });
                }
            };
            input.click();
        }
        
        // Funci√≥n para mostrar error
        function showError(mensaje) {
            errorText.textContent = mensaje;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // Funci√≥n para ocultar todas las secciones
        function hideAllSections() {
            errorMessage.style.display = 'none';
            loading.style.display = 'none';
            resultsSection.style.display = 'none';
            notFound.style.display = 'none';
        }
        
        // Funci√≥n para resetear b√∫squeda
        function resetSearch() {
            hideAllSections();
            envioIdInput.value = '';
            envioIdInput.focus();
        }
        
        // Funci√≥n para imprimir
        function imprimirEnvio() {
            window.print();
        }
        
        // Event Listeners
        btnBuscar.addEventListener('click', buscarEnvio);
        btnScanner.addEventListener('click', abrirScanner);
        closeScanner.addEventListener('click', cerrarScanner);
        btnFileScanner.addEventListener('click', escanearDesdeArchivo);
        
        // Cerrar esc√°ner con ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && scannerModal.style.display === 'flex') {
                cerrarScanner();
            }
        });
        
        // Cerrar esc√°ner haciendo clic fuera del modal
        scannerModal.addEventListener('click', (e) => {
            if (e.target === scannerModal) {
                cerrarScanner();
            }
        });
        
        envioIdInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                buscarEnvio();
            }
        });
        
        // Auto-focus en el input al cargar
        window.addEventListener('DOMContentLoaded', () => {
            envioIdInput.focus();
            
            // Verificar si hay permisos de c√°mara disponibles
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                console.log('C√°mara disponible para esc√°ner');
            } else {
                console.warn('C√°mara no disponible en este dispositivo');
            }
        });
        
        // Permitir pegar y formatear autom√°ticamente
        envioIdInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                this.value = this.value.trim().toUpperCase();
            }, 10);
        });
        // üÜï FUNCIONES PARA MANEJAR EL MODAL DE FIRMA

// üÜï FUNCI√ìN CORREGIDA PARA MOSTRAR FIRMAS DE GOOGLE DRIVE
function mostrarModalFirma(urlFirma, guia) {
  console.log("üì∏ Mostrando firma - URL original:", urlFirma);
  
  const modal = document.getElementById('modalFirmaEntrega');
  const carga = document.getElementById('cargaFirma');
  const contenido = document.getElementById('contenidoFirma');
  const errorDiv = document.getElementById('errorFirma');
  const imgFirma = document.getElementById('imgFirmaEntrega');
  const guiaSpan = document.getElementById('guiaFirma');
  const tituloFirma = document.getElementById('tituloFirma');
  
  // Mostrar modal
  modal.style.display = 'flex';
  carga.style.display = 'block';
  contenido.style.display = 'none';
  errorDiv.style.display = 'none';
  
  // Actualizar informaci√≥n
  guiaSpan.textContent = guia;
  tituloFirma.textContent = `Comprobante de Entrega - ${guia}`;
  
  // üîÑ CONVERTIR URL DE GOOGLE DRIVE SI ES NECESARIO
  let imagenUrl = urlFirma;
  
  // Si es una URL de Google Drive (/file/d/ID/view)
  if (urlFirma.includes('drive.google.com/file/d/')) {
    // Extraer el ID del archivo
    const match = urlFirma.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      // URL directa para im√°genes (formato uc?id=)
      imagenUrl = `https://drive.google.com/uc?id=${fileId}&export=view`;
      console.log("üîÑ URL convertida para Drive:", imagenUrl);
    }
  }
  // Si es una URL de Google Drive (/open?id=ID)
  else if (urlFirma.includes('drive.google.com/open?id=')) {
    const match = urlFirma.match(/id=([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
      const fileId = match[1];
      imagenUrl = `https://drive.google.com/uc?id=${fileId}&export=view`;
      console.log("üîÑ URL convertida para Drive (open):", imagenUrl);
    }
  }
  
  // Configurar imagen
  imgFirma.onload = function() {
    console.log("‚úÖ Imagen cargada correctamente");
    carga.style.display = 'none';
    contenido.style.display = 'block';
    
    // Configurar bot√≥n de descarga
    const btnDescargar = document.getElementById('btnDescargarFirma');
    btnDescargar.onclick = function() {
      // Usar la URL original para descargar
      descargarImagenFirma(urlFirma, guia);
    };
  };
  
  imgFirma.onerror = function() {
    console.error("‚ùå Error cargando imagen, probando m√©todos alternativos...");
    
    // INTENTAR M√âTODO ALTERNATIVO: proxy de imagen
    cargarFirmaConProxy(urlFirma, guia, imgFirma, carga, contenido, errorDiv);
  };
  
  // Intentar cargar la imagen
  console.log("üñºÔ∏è Intentando cargar:", imagenUrl);
  imgFirma.src = imagenUrl;
}

// üÜï FUNCI√ìN ALTERNATIVA PARA CARGAR CON PROXY
function cargarFirmaConProxy(urlOriginal, guia, imgElement, cargaDiv, contenidoDiv, errorDiv) {
  console.log("üîÑ Usando m√©todo proxy para:", urlOriginal);
  
  // Extraer ID de Google Drive
  let fileId = '';
  
  if (urlOriginal.includes('drive.google.com/file/d/')) {
    const match = urlOriginal.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  } else if (urlOriginal.includes('drive.google.com/open?id=')) {
    const match = urlOriginal.match(/id=([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  }
  
  if (fileId) {
    // M√©todo 1: Usar thumbnail de Google Drive
    const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
    console.log("üì± Probando thumbnail:", thumbnailUrl);
    
    const imgTest = new Image();
    imgTest.onload = function() {
      console.log("‚úÖ Thumbnail cargado exitosamente");
      imgElement.src = thumbnailUrl;
      cargaDiv.style.display = 'none';
      contenidoDiv.style.display = 'block';
      
      // Mostrar advertencia de calidad reducida
      const infoDiv = document.querySelector('.firma-info');
      if (infoDiv) {
        const warning = document.createElement('p');
        warning.innerHTML = '<strong>Nota:</strong> Se muestra versi√≥n de vista previa. Para mejor calidad, usa el bot√≥n de descarga.';
        warning.style.color = '#ff9800';
        warning.style.marginTop = '10px';
        infoDiv.appendChild(warning);
      }
    };
    
    imgTest.onerror = function() {
      console.error("‚ùå Thumbnail tambi√©n fall√≥");
      mostrarErrorFirma(errorDiv, cargaDiv, 
        'La imagen del comprobante no est√° disponible para vista previa. ' +
        'Puedes descargarla usando el enlace original.');
    };
    
    imgTest.src = thumbnailUrl;
    
  } else {
    // Si no es Google Drive, mostrar error
    mostrarErrorFirma(errorDiv, cargaDiv, 
      'No se pudo cargar el comprobante. ' +
      'Puede que la imagen no sea accesible p√∫blicamente.');
  }
}

// üÜï FUNCI√ìN PARA MOSTRAR ERROR
function mostrarErrorFirma(errorDiv, cargaDiv, mensaje) {
  cargaDiv.style.display = 'none';
  errorDiv.style.display = 'block';
  document.getElementById('textoErrorFirma').textContent = mensaje;
  
  // Agregar bot√≥n para abrir en nueva pesta√±a
  const btnAbrirEnlace = document.createElement('button');
  btnAbrirEnlace.className = 'btn-secondary';
  btnAbrirEnlace.style.marginLeft = '10px';
  btnAbrirEnlace.innerHTML = '<i class="fas fa-external-link-alt"></i> Abrir enlace';
  btnAbrirEnlace.onclick = function() {
    // Obtener la URL del atributo data-url si existe
    const modal = document.getElementById('modalFirmaEntrega');
    const urlOriginal = modal.dataset.currentUrl || '';
    if (urlOriginal) {
      window.open(urlOriginal, '_blank');
    }
  };
  
  errorDiv.querySelector('button').parentNode.appendChild(btnAbrirEnlace);
}

function cerrarModalFirma() {
  const modal = document.getElementById('modalFirmaEntrega');
  modal.style.display = 'none';
  
  // Limpiar imagen para evitar cache
  const imgFirma = document.getElementById('imgFirmaEntrega');
  imgFirma.src = '';
}

function descargarImagenFirma(url, guia) {
  console.log("üì• Descargando firma para:", guia);
  
  // Para Google Drive, usar enlace directo
  if (url.includes('drive.google.com')) {
    // Convertir a enlace de descarga directa
    let downloadUrl = url;
    
    if (url.includes('/file/d/')) {
      const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        downloadUrl = `https://drive.google.com/uc?export=download&id=${match[1]}`;
      }
    } else if (url.includes('open?id=')) {
      const match = url.match(/id=([a-zA-Z0-9_-]+)/);
      if (match && match[1]) {
        downloadUrl = `https://drive.google.com/uc?export=download&id=${match[1]}`;
      }
    }
    
    console.log("üîó URL de descarga:", downloadUrl);
    
    // Abrir en nueva pesta√±a
    window.open(downloadUrl, '_blank');
    
  } else {
    // Para otras URLs, usar m√©todo normal
    const link = document.createElement('a');
    link.href = url;
    link.download = `Firma_Entrega_${guia}.png`;
    link.target = '_blank';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  
  // Mostrar notificaci√≥n
  showNotificacionDescarga(guia);
}

function showNotificacionDescarga(guia) {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 3000;
    animation: slideInRight 0.3s ease;
    max-width: 300px;
  `;
  notif.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-check-circle"></i>
      <div>
        <strong>Descarga iniciada</strong><br>
        <small>Gu√≠a: ${guia}</small>
      </div>
    </div>
  `;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => {
      document.body.removeChild(notif);
    }, 300);
  }, 3000);
}

function showNotificacionDescarga() {
  // Crear notificaci√≥n temporal
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 3000;
    animation: slideInRight 0.3s ease;
  `;
  notif.innerHTML = `
    <div style="display: flex; align-items: center; gap: 10px;">
      <i class="fas fa-check-circle"></i>
      <span>Comprobante descargado correctamente</span>
    </div>
  `;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => {
      document.body.removeChild(notif);
    }, 300);
  }, 3000);
}

// Agregar animaciones CSS para la notificaci√≥n
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Cerrar modal con ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modalFirma = document.getElementById('modalFirmaEntrega');
    if (modalFirma.style.display === 'flex') {
      cerrarModalFirma();
    }
  }
});

// Cerrar modal haciendo clic fuera
document.getElementById('modalFirmaEntrega').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modalFirmaEntrega')) {
    cerrarModalFirma();
  }
});
    </script>
    <!-- üÜï MODAL PARA VISUALIZAR FIRMA DE ENTREGA -->
<div id="modalFirmaEntrega" class="modal-firma-overlay">
  <div class="modal-firma-container">
    <div class="modal-firma-header">
      <h3><i class="fas fa-file-signature"></i> Comprobante de Entrega</h3>
      <button class="btn-cerrar-modal" onclick="cerrarModalFirma()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-firma-content">
      <div id="cargaFirma" class="carga-firma">
        <i class="fas fa-spinner fa-spin fa-2x pulse" style="color: #1e3c72;"></i>
        <p style="margin-top: 15px;">Cargando comprobante de entrega...</p>
      </div>
      
      <div id="contenidoFirma" style="display: none;">
        <h4 id="tituloFirma">Firma de Entrega</h4>
        
        <div class="firma-imagen-container">
          <img id="imgFirmaEntrega" src="" alt="Firma de entrega">
        </div>
        
        <div class="firma-info">
          <h4><i class="fas fa-info-circle"></i> Informaci√≥n del Comprobante</h4>
          <p><strong>Gu√≠a:</strong> <span id="guiaFirma"></span></p>
          <p><strong>Estado:</strong> <span class="estado-ENTREGADO" style="padding: 3px 10px; border-radius: 12px;">ENTREGADO</span></p>
          <p><strong>Nota:</strong> Esta firma fue capturada digitalmente al momento de la entrega y sirve como comprobante de recepci√≥n.</p>
        </div>
        
        <button id="btnDescargarFirma" class="btn-descargar-firma">
          <i class="fas fa-download"></i>
          Descargar Comprobante
        </button>
      </div>
      
      <div id="errorFirma" class="error-firma" style="display: none;">
        <i class="fas fa-exclamation-triangle fa-2x"></i>
        <h4>Error al cargar el comprobante</h4>
        <p id="textoErrorFirma">No se pudo cargar la imagen del comprobante.</p>
        <button class="btn-secondary" onclick="cerrarModalFirma()" style="margin-top: 15px;">
          <i class="fas fa-times"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
