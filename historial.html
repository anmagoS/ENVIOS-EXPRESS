<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Historial de Env√≠os - Sistema de Entrega</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-dark": "#0f4bc4",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a202c",
                        "success": "#10b981",
                        "warning": "#f59e0b",
                        "danger": "#ef4444"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <!-- EN EL HEAD DE guia.html -->
<script>
    // VERIFICACI√ìN DE AUTENTICACI√ìN
    (function() {
        const usuario = JSON.parse(localStorage.getItem("usuarioLogueado"));
        
        if (!usuario) {
            console.log("‚ùå No autorizado para ver gu√≠as");
            window.location.replace("login.html");
            return;
        }
        
        console.log("‚úÖ Usuario autorizado para gu√≠as:", usuario.USUARIO);
    })();
</script>
    <style>
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .badge-pagado { background-color: #10b981; color: white; }
        .badge-pendiente { background-color: #f59e0b; color: white; }
        .badge-sin-pago { background-color: #ef4444; color: white; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
        
        /* Animaciones para modales */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 300ms, transform 300ms;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen text-gray-800 dark:text-gray-200">
    
    <!-- Loading screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-gray-900">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary mb-6"></div>
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Cargando historial</h2>
            <p class="text-gray-600 dark:text-gray-400" id="loadingText">Por favor espera...</p>
        </div>
    </div>
    
    <!-- Main content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 w-full bg-surface-light dark:bg-surface-dark border-b border-gray-200 dark:border-gray-800 px-6 py-3 shadow-sm">
            <div class="mx-auto max-w-7xl flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="flex items-center justify-center size-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Volver al inicio">
                        <span class="material-symbols-outlined text-primary">arrow_back</span>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold">üìã Historial de Env√≠os</h1>
                        <p class="text-sm text-gray-600 dark:text-gray-400" id="usuarioInfo">Cargando informaci√≥n...</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btnRefresh" class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Actualizar">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">refresh</span>
                    </button>
                    
                    <button id="btnDarkMode" class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Modo oscuro">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400" id="darkModeIcon">dark_mode</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main content -->
        <main class="w-full px-4 py-6 md:px-6 lg:px-8">
            <div class="max-w-7xl mx-auto">
                
                <!-- Filtros r√°pidos -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h3 class="font-bold flex items-center gap-2 mb-2">
                                <span class="material-symbols-outlined text-primary">filter_alt</span>
                                Filtros de b√∫squeda
                            </h3>
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Desde:</label>
                                    <input type="date" id="fechaDesde" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Hasta:</label>
                                    <input type="date" id="fechaHasta" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Forma Pago:</label>
                                    <select id="formaPagoFilter" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                        <option value="todas">Todas</option>
                                        <option value="contado">Contado</option>
                                        <option value="contraentrega">Contraentrega</option>
                                        <option value="contraentrega_recaudo">Con Recaudo</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Estado Pago:</label>
                                    <select id="estadoPagoFilter" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                        <option value="todos">Todos</option>
                                        <option value="pagado">Pagados</option>
                                        <option value="pendiente">Pendientes</option>
                                        <option value="sin_pago">Sin pago</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label class="text-sm">Buscar:</label>
                                    <input type="text" id="busqueda" placeholder="ID, Destinatario, Barrio..." class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="btnAplicarFiltros" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
                                <span class="material-symbols-outlined text-sm">search</span>
                                Aplicar
                            </button>
                            <button id="btnLimpiarFiltros" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-sm transition-colors">
                                Limpiar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjetas de estad√≠sticas -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Total Env√≠os</p>
                                <p class="text-2xl font-bold" id="totalEnvios">0</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-blue-500">local_shipping</span>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Pendiente Total a Pagar</p>
                                <p class="text-2xl font-bold text-green-600" id="totalPagar">$0</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-green-500">payments</span>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Promedio a Pagar</p>
                                <p class="text-2xl font-bold text-orange-600" id="promedioPagar">$0</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-orange-500">trending_up</span>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">√öltimo Env√≠o</p>
                                <p class="text-2xl font-bold text-purple-600" id="ultimoEnvio">-</p>
                            </div>
                            <span class="material-symbols-outlined text-3xl text-purple-500">calendar_today</span>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de env√≠os -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                        <h3 class="font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">list_alt</span>
                            Env√≠os Registrados
                        </h3>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-600 dark:text-gray-400" id="contadorEnvios">0 env√≠os</span>
                            <select id="ordenarPor" class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded text-sm dark:bg-gray-700 dark:text-white">
                                <option value="fecha_desc">M√°s recientes</option>
                                <option value="fecha_asc">M√°s antiguos</option>
                                <option value="valor_desc">Mayor valor</option>
                                <option value="valor_asc">Menor valor</option>
                                <option value="destino_asc">Destino (A-Z)</option>
                                <option value="destino_desc">Destino (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="py-3 px-4 text-left text-sm font-medium">ID Gu√≠a</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Fecha</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Destinatario</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Forma Pago</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Valor a Recaudar</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Total a Pagar</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Estado</th>
                                    <th class="py-3 px-4 text-left text-sm font-medium">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaEnvios" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Se llena con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sin resultados -->
                    <div id="sinResultados" class="hidden p-8 text-center">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">inbox</span>
                        <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300">No hay env√≠os registrados</h4>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">No se encontraron env√≠os con los filtros aplicados</p>
                        <button id="btnResetearFiltros" class="mt-4 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium">
                            Resetear filtros
                        </button>
                    </div>
                    
                    <!-- Loading tabla -->
                    <div id="tablaLoading" class="p-8 text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-2"></div>
                        <p class="text-gray-500 dark:text-gray-400">Cargando env√≠os...</p>
                    </div>
                    
                    <!-- Paginaci√≥n -->
                    <div id="paginacion" class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 hidden">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                Mostrando <span id="paginaInicio">1</span>-<span id="paginaFin">10</span> de <span id="totalItems">0</span>
                            </div>
                            <div class="flex gap-1">
                                <button id="btnAnterior" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                    ‚Üê Anterior
                                </button>
                                <span class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400" id="paginaActual">1</span>
                                <button id="btnSiguiente" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                    Siguiente ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal detalles -->
    <div id="modalDetalles" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="modalBackdrop"></div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl sm:w-full">
                <div class="px-6 py-4 bg-primary text-white">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">üìÑ Detalles del Env√≠o</h3>
                        <button id="btnCerrarModal" class="text-white hover:text-gray-200 transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                    <div id="modalDetallesContenido">
                        <!-- Cargado din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n -->
    <div id="modalConfirmacion" class="fixed inset-0 z-[110] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="confirmacionBackdrop"></div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-md sm:w-full">
                <div class="px-6 py-4 bg-warning text-white">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">‚ö†Ô∏è Confirmaci√≥n</h3>
                        <button onclick="cerrarModalConfirmacion()" class="text-white hover:text-gray-200">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4">
                    <p id="confirmacionMensaje"></p>
                    <div class="mt-6 flex justify-end gap-3">
                        <button onclick="cerrarModalConfirmacion()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancelar
                        </button>
                        <button id="btnConfirmarAccion" class="px-4 py-2 bg-warning hover:bg-amber-600 text-white rounded-lg">
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n toast -->
    <div id="toast" class="fixed top-4 right-4 z-[120] hidden">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-start">
                <span class="material-symbols-outlined mr-3" id="toastIcon">info</span>
                <div class="flex-1">
                    <h4 class="font-bold" id="toastTitle">Notificaci√≥n</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="toastMessage"></p>
                </div>
                <button onclick="cerrarToast()" class="ml-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Configuraci√≥n
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIipuPmVAvaTt7_oUQzMLNtXIah19dcq2CWkaoglQvFivqY-wBYEw64tvUmL4-1k62/exec";
        
        // Variables globales
        let usuarioActual = null;
        let todosEnvios = [];
        let enviosFiltrados = [];
        let paginaActual = 1;
        const itemsPorPagina = 15;
        let confirmacionCallback = null;
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            inicializarAplicacion();
        });
        
        // Funci√≥n para determinar si un env√≠o est√° pagado
        function determinarSiEstaPagado(estado) {
            if (estado === undefined || estado === null || estado === "") {
                return false;
            }
            
            // Si es booleano
            if (typeof estado === 'boolean') {
                return estado === true;
            }
            
            // Si es string
            if (typeof estado === 'string') {
                const estadoUpper = estado.toUpperCase().trim();
                return estadoUpper === 'SI' || 
                       estadoUpper === 'TRUE' || 
                       estadoUpper === 'VERDADERO' || 
                       estadoUpper === '1' || 
                       estadoUpper === 'YES' || 
                       estadoUpper === 'PAGADO' ||
                       estadoUpper === 'PAGO';
            }
            
            // Si es n√∫mero
            if (typeof estado === 'number') {
                return estado === 1;
            }
            
            return false;
        }
        
        function inicializarAplicacion() {
            // 1. Determinar usuario
            determinarUsuario();
            
            // 2. Configurar eventos
            configurarEventos();
            
            // 3. Configurar modo oscuro
            configurarModoOscuro();
            
            // 4. Configurar fechas por defecto (√∫ltimos 30 d√≠as)
            configurarFechasPorDefecto();
        }
        
        function determinarUsuario() {
            try {
                // Intentar obtener usuario de la URL
                const urlParams = new URLSearchParams(window.location.search);
                const usuarioParam = urlParams.get('usuario');
                
                // Intentar obtener de localStorage
                let usuarioLogueado = null;
                try {
                    const usuarioStorage = localStorage.getItem('usuarioLogueado');
                    if (usuarioStorage) {
                        usuarioLogueado = JSON.parse(usuarioStorage);
                    }
                } catch (e) {
                    console.warn('No se pudo parsear usuario de localStorage:', e);
                }
                
                // Priorizar par√°metro de URL
                if (usuarioParam) {
                    usuarioActual = { 
                        USUARIO: usuarioParam, 
                        ROL: 'CLIENTE',
                        "NOMBRE COMPLETO": usuarioParam 
                    };
                    document.getElementById('loadingText').textContent = `Cargando historial de ${usuarioParam}...`;
                } else if (usuarioLogueado && usuarioLogueado.USUARIO) {
                    usuarioActual = usuarioLogueado;
                } else {
                    // Redirigir si no hay usuario
                    console.log('No hay usuario identificado, redirigiendo a login...');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Actualizar info del usuario
                actualizarInfoUsuario();
                
                // Cargar historial
                cargarHistorial();
                
            } catch (error) {
                console.error('Error determinando usuario:', error);
                mostrarError('Error al identificar usuario: ' + error.message);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        function actualizarInfoUsuario() {
            try {
                const texto = usuarioActual["NOMBRE COMPLETO"] || usuarioActual.USUARIO || 'Usuario';
                const rol = usuarioActual.ROL || 'CLIENTE';
                document.getElementById('usuarioInfo').textContent = `${texto} ‚Ä¢ ${rol}`;
                
                // Si es ADMIN, cambiar t√≠tulo
                if (usuarioActual.ROL === 'ADMIN') {
                    document.title = `Historial - ${texto} (Admin)`;
                } else {
                    document.title = `Historial de Env√≠os - ${texto}`;
                }
            } catch (error) {
                console.error('Error actualizando info usuario:', error);
            }
        }
        
        function configurarEventos() {
            // Bot√≥n refrescar
            document.getElementById('btnRefresh').addEventListener('click', cargarHistorial);
            
            // Bot√≥n modo oscuro
            document.getElementById('btnDarkMode').addEventListener('click', toggleModoOscuro);
            
            // Filtros
            document.getElementById('btnAplicarFiltros').addEventListener('click', function(e) {
                e.preventDefault();
                aplicarFiltros();
            });
            document.getElementById('btnLimpiarFiltros').addEventListener('click', function(e) {
                e.preventDefault();
                limpiarFiltros();
            });
            document.getElementById('btnResetearFiltros').addEventListener('click', function(e) {
                e.preventDefault();
                limpiarFiltros();
            });
            
            // Buscar al escribir
            document.getElementById('busqueda').addEventListener('input', debounce(aplicarFiltros, 300));
            
            // Ordenar
            document.getElementById('ordenarPor').addEventListener('change', function() {
                ordenarEnvios();
            });
            
            // Paginaci√≥n
            document.getElementById('btnAnterior').addEventListener('click', () => cambiarPagina(-1));
            document.getElementById('btnSiguiente').addEventListener('click', () => cambiarPagina(1));
            
            // Filtros autom√°ticos
            document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
            document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
            document.getElementById('formaPagoFilter').addEventListener('change', aplicarFiltros);
            document.getElementById('estadoPagoFilter').addEventListener('change', aplicarFiltros);
            
            // Modal
            document.getElementById('modalBackdrop').addEventListener('click', cerrarModalDetalles);
            document.getElementById('btnCerrarModal').addEventListener('click', cerrarModalDetalles);
            
            // Confirmaci√≥n modal
            document.getElementById('confirmacionBackdrop').addEventListener('click', cerrarModalConfirmacion);
            
            // Tecla Escape para cerrar modales
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModalDetalles();
                    cerrarModalConfirmacion();
                    cerrarToast();
                }
            });
        }
        
        function configurarModoOscuro() {
            // Verificar preferencia guardada
            const modoOscuro = localStorage.getItem('modoOscuro') === 'true';
            
            if (modoOscuro) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
            }
        }
        
        function toggleModoOscuro() {
            const tieneModoOscuro = document.documentElement.classList.contains('dark');
            
            if (tieneModoOscuro) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('modoOscuro', 'false');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('modoOscuro', 'true');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            }
        }
        
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            // Formatear como YYYY-MM-DD
            const hoyFormato = hoy.toISOString().split('T')[0];
            const hace30DiasFormato = hace30Dias.toISOString().split('T')[0];
            
            document.getElementById('fechaDesde').value = hace30DiasFormato;
            document.getElementById('fechaHasta').value = hoyFormato;
        }
        
        async function cargarHistorial() {
            try {
                if (!usuarioActual || !usuarioActual.USUARIO) {
                    throw new Error('Usuario no identificado');
                }
                
                // Mostrar loading
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                
                // Mostrar loading en tabla
                document.getElementById('tablaLoading').classList.remove('hidden');
                document.getElementById('sinResultados').classList.add('hidden');
                document.getElementById('tablaEnvios').innerHTML = '';
                
                console.log('üîÑ Cargando historial para usuario:', usuarioActual.USUARIO);
                
                // Cargar desde Web App
                await cargarDesdeWebApp();
                
                // Si no hay datos, intentar localStorage
                if (todosEnvios.length === 0) {
                    await cargarDesdeLocalStorage();
                }
                
                // Procesar datos
                procesarDatos();
                
                // Mostrar notificaci√≥n
                mostrarToast('success', 'Historial cargado', `Se cargaron ${todosEnvios.length} env√≠os`);
                
            } catch (error) {
                console.error('‚ùå Error cargando historial:', error);
                mostrarError('Error al cargar historial: ' + error.message);
                mostrarToast('error', 'Error', 'No se pudo cargar el historial');
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('tablaLoading').classList.add('hidden');
            }
        }
        
        async function cargarDesdeWebApp() {
            try {
                console.log('üì° Cargando historial desde Web App...');
                
                const url = `${WEB_APP_URL}?action=getHistorialCliente&usuarioId=${encodeURIComponent(usuarioActual.USUARIO)}`;
                console.log('URL de consulta:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos:', data);
                
                if (data && Array.isArray(data)) {
                    todosEnvios = data.map(envio => {
                        // Extraer valores correctamente
                        const valorRecaudar = parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0);
                        const totalPagar = parseFloat(envio["TOTAL A PAGAR"] || envio.totalPagar || 0);
                        const formaPago = envio["FORMA DE PAGO"] || envio.formaPago || '';
                        const pagadoRemitente = envio["PAGADO A REMITENTE"] || envio.pagadoRemitente || false;
                        
                        return {
                            // Copiar todos los campos del env√≠o
                            ...envio,
                            // Campos normalizados
                            "ENVIO ID": envio["ENVIO ID"] || envio.id || `ENV-${Date.now()}`,
                            "DESTINO": envio["DESTINO"] || envio.destino || 'N/A',
                            "BARRIO": envio["BARRIO"] || envio.barrio || '',
                            "FORMA DE PAGO": formaPago,
                            "PAGADO A REMITENTE": pagadoRemitente,
                            "FECHA PAGO": envio["FECHA PAGO"] || envio.fechaPago || null,
                            "REMITE": envio["REMITE"] || envio.remite || 'N/A',
                            "TELEFONO": envio["TELEFONO"] || envio.telefono || 'N/A',
                            "DIRECCION": envio["DIRECCION"] || envio.direccion || 'N/A',
                            "CORREO REMITENTE": envio["CORREO REMITENTE"] || envio.correo || 'N/A',
                            "TELEFONOCLIENTE": envio["TELEFONOCLIENTE"] || envio.telefonoCliente || 'N/A',
                            "DIRECCION DESTINO": envio["DIRECCION DESTINO"] || envio.direccionDestino || 'N/A',
                            "LOCALIDAD": envio["LOCALIDAD"] || envio.localidad || 'N/A',
                            "CIUDAD DESTINO": envio["CIUDAD DESTINO"] || envio.ciudadDestino || 'N/A',
                            "MENSAJERO": envio["MENSAJERO"] || envio.mensajero || 'Por asignar',
                            "OBS": envio["OBS"] || envio.observaciones || 'Ninguna',
                            // Campos num√©ricos
                            valorRecaudar: isNaN(valorRecaudar) ? 0 : valorRecaudar,
                            totalPagar: isNaN(totalPagar) ? 0 : totalPagar,
                            // Usuario
                            usuarioId: envio.usuarioId || envio["USUARIO ID"] || usuarioActual.USUARIO
                        };
                    });
                    
                    console.log(`‚úÖ ${todosEnvios.length} env√≠os cargados desde Web App`);
                    console.log('Muestra de env√≠os:', todosEnvios.slice(0, 3));
                    
                    // Guardar en localStorage para futuras consultas
                    guardarEnLocalStorage();
                    
                } else {
                    console.log('‚ö†Ô∏è Respuesta vac√≠a o no es array');
                    todosEnvios = [];
                }
                
            } catch (error) {
                console.log('‚ö†Ô∏è No se pudo cargar desde Web App:', error.message);
                todosEnvios = [];
            }
        }
        
        async function cargarDesdeLocalStorage() {
            try {
                const historialGuardado = JSON.parse(localStorage.getItem('historialCompleto')) || [];
                
                if (historialGuardado.length === 0) {
                    console.log('üìÇ No hay datos en localStorage');
                    return;
                }
                
                // Filtrar por usuario actual
                todosEnvios = historialGuardado.filter(envio => {
                    const envioUsuarioId = envio.usuarioId || envio["USUARIO ID"];
                    return envioUsuarioId === usuarioActual.USUARIO;
                }).map(envio => ({
                    ...envio,
                    // Convertir valores num√©ricos
                    valorRecaudar: parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0),
                    totalPagar: parseFloat(envio["TOTAL A PAGAR"] || envio.totalPagar || 0)
                }));
                
                console.log(`üìÇ ${todosEnvios.length} env√≠os cargados desde localStorage`);
                
            } catch (error) {
                console.error('Error cargando desde localStorage:', error);
                todosEnvios = [];
            }
        }
        
        function guardarEnLocalStorage() {
            try {
                if (todosEnvios.length === 0) return;
                
                let historialExistente = [];
                try {
                    const historialStorage = localStorage.getItem('historialCompleto');
                    if (historialStorage) {
                        historialExistente = JSON.parse(historialStorage);
                    }
                } catch (e) {
                    console.warn('No se pudo parsear historial existente:', e);
                    historialExistente = [];
                }
                
                // Crear mapa de env√≠os existentes por ID
                const enviosMap = new Map();
                historialExistente.forEach(envio => {
                    const id = envio["ENVIO ID"] || envio.id;
                    if (id) enviosMap.set(id, envio);
                });
                
                // Actualizar o agregar nuevos env√≠os
                todosEnvios.forEach(envio => {
                    const id = envio["ENVIO ID"] || envio.id;
                    if (id) {
                        enviosMap.set(id, {
                            ...envio,
                            fechaActualizacion: new Date().toISOString()
                        });
                    }
                });
                
                // Convertir mapa a array
                const historialActualizado = Array.from(enviosMap.values());
                
                localStorage.setItem('historialCompleto', JSON.stringify(historialActualizado));
                console.log('üíæ Historial guardado en localStorage');
                
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
            }
        }
        
        function procesarDatos() {
            // Aplicar filtros iniciales
            aplicarFiltros();
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas();
        }
        
        // FUNCI√ìN CORREGIDA: aplicarFiltros
        function aplicarFiltros() {
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            const formaPago = document.getElementById('formaPagoFilter').value;
            const estadoPago = document.getElementById('estadoPagoFilter').value;
            const busqueda = document.getElementById('busqueda').value.toLowerCase().trim();
            
            console.log('üîç Aplicando filtros:', { 
                fechaDesde, 
                fechaHasta, 
                formaPago, 
                estadoPago, 
                busqueda,
                totalEnvios: todosEnvios.length 
            });
            
            // Filtrar
            enviosFiltrados = todosEnvios.filter(envio => {
                let cumple = true;
                
                // 1. Filtrar por fecha si hay fechas seleccionadas
                if (fechaDesde || fechaHasta) {
                    const fechaEnvio = obtenerFechaEnvio(envio);
                    
                    // Si solo hay fechaDesde
                    if (fechaDesde && !fechaHasta) {
                        const desde = new Date(fechaDesde);
                        desde.setHours(0, 0, 0, 0);
                        cumple = cumple && (fechaEnvio >= desde);
                    }
                    // Si solo hay fechaHasta
                    else if (!fechaDesde && fechaHasta) {
                        const hasta = new Date(fechaHasta);
                        hasta.setHours(23, 59, 59, 999);
                        cumple = cumple && (fechaEnvio <= hasta);
                    }
                    // Si hay ambas fechas
                    else if (fechaDesde && fechaHasta) {
                        const desde = new Date(fechaDesde);
                        desde.setHours(0, 0, 0, 0);
                        const hasta = new Date(fechaHasta);
                        hasta.setHours(23, 59, 59, 999);
                        cumple = cumple && (fechaEnvio >= desde && fechaEnvio <= hasta);
                    }
                    
                    if (!cumple) return false;
                }
                
                // 2. Filtrar por forma de pago
                if (formaPago && formaPago !== 'todas') {
                    const formaPagoEnvio = (envio["FORMA DE PAGO"] || '').toLowerCase();
                    
                    console.log(`Comparando forma de pago: "${formaPago}" vs "${formaPagoEnvio}"`);
                    
                    // Mapear valores para coincidencia
                    if (formaPago === 'contraentrega_recaudo') {
                        // Buscar "con recaudo" o "contraentrega_recaudo"
                        cumple = cumple && (
                            formaPagoEnvio.includes('recaudo') || 
                            formaPagoEnvio === 'contraentrega_recaudo' ||
                            formaPagoEnvio === 'con recaudo'
                        );
                    } else {
                        cumple = cumple && (formaPagoEnvio === formaPago);
                    }
                    
                    if (!cumple) {
                        console.log(`‚ùå No coincide forma de pago: ${formaPagoEnvio} != ${formaPago}`);
                        return false;
                    }
                }
                
                // 3. Filtrar por estado de pago
                if (estadoPago && estadoPago !== 'todos') {
                    const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                    const totalPagar = envio.totalPagar || 0;
                    
                    console.log(`Estado de pago: pagado=${estaPagado}, totalPagar=${totalPagar}, filtro=${estadoPago}`);
                    
                    switch(estadoPago) {
                        case 'pagado':
                            cumple = cumple && estaPagado;
                            break;
                        case 'pendiente':
                            cumple = cumple && !estaPagado && (totalPagar > 0);
                            break;
                        case 'sin_pago':
                            cumple = cumple && (totalPagar === 0);
                            break;
                    }
                    
                    if (!cumple) {
                        console.log(`‚ùå No coincide estado de pago`);
                        return false;
                    }
                }
                
                // 4. Filtrar por b√∫squeda de texto
                if (busqueda) {
                    // Lista de campos donde buscar
                    const camposBusqueda = [
                        envio["ENVIO ID"] || '',
                        envio.id || '',
                        envio["DESTINO"] || '',
                        envio.destino || '',
                        envio["BARRIO"] || '',
                        envio.barrio || '',
                        envio["REMITE"] || '',
                        envio.remite || '',
                        envio["TELEFONO"] || '',
                        envio.telefono || '',
                        envio["TELEFONOCLIENTE"] || '',
                        envio.telefonoCliente || ''
                    ];
                    
                    // Convertir todos a string y buscar
                    const textoBusqueda = busqueda.toLowerCase();
                    const coincide = camposBusqueda.some(campo => {
                        if (!campo) return false;
                        return campo.toString().toLowerCase().includes(textoBusqueda);
                    });
                    
                    cumple = cumple && coincide;
                }
                
                return cumple;
            });
            
            console.log(`‚úÖ ${enviosFiltrados.length} env√≠os despu√©s de filtrar (de ${todosEnvios.length} totales)`);
            
            // Ordenar
            ordenarEnvios();
            
            // Mostrar primera p√°gina
            paginaActual = 1;
            mostrarPagina();
            
            // Actualizar estad√≠sticas
            actualizarEstadisticas();
        }
        
        function obtenerFechaEnvio(envio) {
            // Intentar diferentes formatos de fecha
            const posiblesFechas = [
                envio["FECHA PAGO"],
                envio.fechaPago,
                envio["FECHA REGISTRO"],
                envio.fechaRegistro,
                envio.fecha,
                envio.fechaCreacion,
                envio.timestamp,
                envio["FECHA ENVIO"],
                envio.fechaEnvio
            ];
            
            for (let fechaStr of posiblesFechas) {
                if (fechaStr) {
                    let fecha = new Date(fechaStr);
                    
                    // Si es inv√°lida, intentar otros formatos
                    if (isNaN(fecha.getTime()) && typeof fechaStr === 'string') {
                        // Formato dd/mm/yyyy
                        const match = fechaStr.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
                        if (match) {
                            fecha = new Date(`${match[3]}-${match[2].padStart(2, '0')}-${match[1].padStart(2, '0')}`);
                        }
                    }
                    
                    // Si la fecha es v√°lida, retornarla
                    if (!isNaN(fecha.getTime())) {
                        return fecha;
                    }
                }
            }
            
            // Si no hay fecha v√°lida, usar fecha de ayer
            const fechaDefault = new Date();
            fechaDefault.setDate(fechaDefault.getDate() - 1);
            return fechaDefault;
        }
        
        function ordenarEnvios() {
            const orden = document.getElementById('ordenarPor').value;
            
            enviosFiltrados.sort((a, b) => {
                const fechaA = obtenerFechaEnvio(a);
                const fechaB = obtenerFechaEnvio(b);
                const valorA = parseFloat(a.totalPagar || a["TOTAL A PAGAR"] || 0);
                const valorB = parseFloat(b.totalPagar || b["TOTAL A PAGAR"] || 0);
                const destinoA = (a["DESTINO"] || a.destino || '').toLowerCase();
                const destinoB = (b["DESTINO"] || b.destino || '').toLowerCase();
                
                switch (orden) {
                    case 'fecha_desc':
                        return fechaB.getTime() - fechaA.getTime(); // M√°s reciente primero
                    case 'fecha_asc':
                        return fechaA.getTime() - fechaB.getTime(); // M√°s antiguo primero
                    case 'valor_desc':
                        return valorB - valorA; // Mayor valor primero
                    case 'valor_asc':
                        return valorA - valorB; // Menor valor primero
                    case 'destino_asc':
                        return destinoA.localeCompare(destinoB); // A-Z
                    case 'destino_desc':
                        return destinoB.localeCompare(destinoA); // Z-A
                    default:
                        return fechaB.getTime() - fechaA.getTime(); // Por defecto: m√°s reciente primero
                }
            });
            
            mostrarPagina();
        }
        
        function mostrarPagina() {
            const tbody = document.getElementById('tablaEnvios');
            const sinResultados = document.getElementById('sinResultados');
            const tablaLoading = document.getElementById('tablaLoading');
            const paginacion = document.getElementById('paginacion');
            const contador = document.getElementById('contadorEnvios');
            
            // Ocultar loading
            tablaLoading.classList.add('hidden');
            
            // Verificar si hay resultados
            if (enviosFiltrados.length === 0) {
                tbody.innerHTML = '';
                sinResultados.classList.remove('hidden');
                paginacion.classList.add('hidden');
                contador.textContent = '0 env√≠os';
                
                // Mensaje espec√≠fico seg√∫n filtros
                const hayFiltros = document.getElementById('fechaDesde').value || 
                                  document.getElementById('fechaHasta').value || 
                                  document.getElementById('formaPagoFilter').value !== 'todas' || 
                                  document.getElementById('estadoPagoFilter').value !== 'todos' ||
                                  document.getElementById('busqueda').value;
                
                if (hayFiltros) {
                    sinResultados.querySelector('h4').textContent = 'No hay env√≠os con los filtros aplicados';
                    sinResultados.querySelector('p').textContent = 'Intenta con otros criterios de b√∫squeda';
                } else {
                    sinResultados.querySelector('h4').textContent = 'No hay env√≠os registrados';
                    sinResultados.querySelector('p').textContent = 'No se encontraron env√≠os en el historial';
                }
                
                return;
            }
            
            // Ocultar mensaje sin resultados
            sinResultados.classList.add('hidden');
            
            // Calcular paginaci√≥n
            const totalPaginas = Math.ceil(enviosFiltrados.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = Math.min(inicio + itemsPorPagina, enviosFiltrados.length);
            const enviosPagina = enviosFiltrados.slice(inicio, fin);
            
            // Actualizar controles de paginaci√≥n
            document.getElementById('paginaInicio').textContent = inicio + 1;
            document.getElementById('paginaFin').textContent = fin;
            document.getElementById('totalItems').textContent = enviosFiltrados.length;
            document.getElementById('paginaActual').textContent = `${paginaActual} de ${totalPaginas}`;
            
            document.getElementById('btnAnterior').disabled = paginaActual <= 1;
            document.getElementById('btnSiguiente').disabled = paginaActual >= totalPaginas;
            
            // Mostrar paginaci√≥n si hay m√°s de una p√°gina
            if (totalPaginas > 1) {
                paginacion.classList.remove('hidden');
            } else {
                paginacion.classList.add('hidden');
            }
            
            // Generar filas de la tabla
            let html = '';
            enviosPagina.forEach((envio, index) => {
                const fecha = obtenerFechaEnvio(envio);
                const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                // Forma de pago
                let formaPagoTexto = '';
                const formaPago = envio["FORMA DE PAGO"] || '';
                switch(formaPago.toLowerCase()) {
                    case 'contado': formaPagoTexto = 'Contado'; break;
                    case 'contraentrega': formaPagoTexto = 'Contraentrega'; break;
                    case 'contraentrega_recaudo': 
                    case 'con recaudo':
                        formaPagoTexto = 'Con Recaudo'; 
                        break;
                    default: formaPagoTexto = formaPago || 'N/A';
                }
                
                // Estado de pago
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                const valorRecaudar = parseFloat(envio.valorRecaudar || envio["VALOR A RECAUDAR"] || 0);
                const totalPagar = parseFloat(envio.totalPagar || envio["TOTAL A PAGAR"] || 0);
                
                let estadoHTML = '';
                let estadoClase = '';
                
                if (estaPagado) {
                    estadoHTML = 'Pagado';
                    estadoClase = 'badge-pagado';
                } else if (totalPagar > 0) {
                    estadoHTML = 'Pendiente';
                    estadoClase = 'badge-pendiente';
                } else {
                    estadoHTML = 'Sin pago';
                    estadoClase = 'badge-sin-pago';
                }
                
                // ID del env√≠o (escapear caracteres especiales)
                const envioId = (envio["ENVIO ID"] || envio.id || 'N/A').replace(/'/g, "\\'");
                
                html += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="py-3 px-4">
                            <span class="font-mono font-bold text-sm">${envio["ENVIO ID"] || envio.id || 'N/A'}</span>
                        </td>
                        <td class="py-3 px-4 text-sm">${fechaFormateada}</td>
                        <td class="py-3 px-4">
                            <div class="font-medium">${envio["DESTINO"] || envio.destino || 'N/A'}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${envio["BARRIO"] || envio.barrio || ''}</div>
                        </td>
                        <td class="py-3 px-4 text-sm">${formaPagoTexto}</td>
                        <td class="py-3 px-4 font-medium text-blue-600 dark:text-blue-400">
                            $${valorRecaudar.toLocaleString('es-CO')}
                        </td>
                        <td class="py-3 px-4 font-bold text-green-600 dark:text-green-400">
                            $${totalPagar.toLocaleString('es-CO')}
                        </td>
                        <td class="py-3 px-4">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoClase}">
                                ${estadoHTML}
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            <button onclick="verDetalles('${envioId}')" 
                                    class="px-3 py-1 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm flex items-center gap-1 transition-colors">
                                <span class="material-symbols-outlined text-sm">visibility</span>
                                Ver
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            contador.textContent = `${enviosFiltrados.length} env√≠os`;
        }
        
        function cambiarPagina(direccion) {
            const totalPaginas = Math.ceil(enviosFiltrados.length / itemsPorPagina);
            const nuevaPagina = paginaActual + direccion;
            
            // Limitar entre 1 y totalPaginas
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                mostrarPagina();
                
                // Scroll suave al inicio de la tabla
                document.querySelector('#tablaEnvios').closest('div').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
        
        function actualizarEstadisticas() {
            const totalEnvios = enviosFiltrados.length;
            
            if (totalEnvios === 0) {
                document.getElementById('totalEnvios').textContent = '0';
                document.getElementById('totalPagar').textContent = '$0';
                document.getElementById('promedioPagar').textContent = '$0';
                document.getElementById('ultimoEnvio').textContent = '-';
                return;
            }
            
            // Calcular total a pagar SOLO DE PENDIENTES
            let totalPagar = 0;
            let enviosPendientes = 0;
            
            enviosFiltrados.forEach(envio => {
                const valorPagar = parseFloat(envio.totalPagar || envio["TOTAL A PAGAR"] || 0);
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                
                if (!isNaN(valorPagar)) {
                    // Solo sumar si NO est√° pagado
                    if (!estaPagado && valorPagar > 0) {
                        totalPagar += valorPagar;
                        enviosPendientes++;
                    }
                }
            });
            
            const promedioPagar = enviosPendientes > 0 ? totalPagar / enviosPendientes : 0;
            
            // √öltimo env√≠o
            let ultimoEnvio = '-';
            if (enviosFiltrados.length > 0) {
                const ultimo = enviosFiltrados[0]; // Ya est√° ordenado por fecha_desc por defecto
                const fecha = obtenerFechaEnvio(ultimo);
                ultimoEnvio = fecha.toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: '2-digit'
                });
            }
            
            // Actualizar UI
            document.getElementById('totalEnvios').textContent = totalEnvios.toLocaleString();
            document.getElementById('totalPagar').textContent = `$${totalPagar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            document.getElementById('promedioPagar').textContent = `$${promedioPagar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            document.getElementById('ultimoEnvio').textContent = ultimoEnvio;
        }
        
        function verDetalles(envioId) {
            const envio = todosEnvios.find(e => 
                e["ENVIO ID"] === envioId || 
                e.id === envioId
            );
            
            if (!envio) {
                mostrarError('No se encontraron detalles del env√≠o');
                return;
            }
            
            const fecha = obtenerFechaEnvio(envio);
            const fechaFormateada = fecha.toLocaleString('es-CO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Forma de pago
            let formaPagoTexto = '';
            const formaPago = envio["FORMA DE PAGO"] || '';
            switch(formaPago.toLowerCase()) {
                case 'contado': formaPagoTexto = 'Contado'; break;
                case 'contraentrega': formaPagoTexto = 'Contraentrega'; break;
                case 'contraentrega_recaudo': 
                case 'con recaudo':
                    formaPagoTexto = 'Con Recaudo'; 
                    break;
                default: formaPagoTexto = formaPago || 'N/A';
            }
            
            // Estado de pago
            const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
            const estadoPagoTexto = estaPagado ? 'Pagado' : 'Pendiente';
            const estadoPagoColor = estaPagado ? 'text-green-600' : 'text-yellow-600';
            
            // Fecha de pago si existe
            let fechaPagoTexto = '';
            if (envio["FECHA PAGO"]) {
                try {
                    const fechaPago = new Date(envio["FECHA PAGO"]);
                    fechaPagoTexto = fechaPago.toLocaleDateString('es-CO', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    fechaPagoTexto = envio["FECHA PAGO"];
                }
            }
            
            let html = `
                <div class="space-y-4">
                    <!-- Encabezado -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <div>
                                <div class="font-bold text-lg mb-1">ID: ${envio["ENVIO ID"] || envio.id}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    <span class="material-symbols-outlined align-text-bottom text-sm">schedule</span>
                                    Registrado: ${fechaFormateada}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg text-green-600">$${(envio.totalPagar || 0).toLocaleString('es-CO')}</div>
                                <div class="text-sm text-gray-500">Total a Pagar</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Remitente -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">person</span>
                                Remitente
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Nombre:</span> ${envio["REMITE"] || envio.remite || 'N/A'}</p>
                                <p><span class="font-medium">Tel√©fono:</span> ${envio["TELEFONO"] || envio.telefono || 'N/A'}</p>
                                <p><span class="font-medium">Direcci√≥n:</span> ${envio["DIRECCION"] || envio.direccion || 'N/A'}</p>
                                <p><span class="font-medium">Correo:</span> ${envio["CORREO REMITENTE"] || envio.correo || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Destinatario -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">location_on</span>
                                Destinatario
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Nombre:</span> ${envio["DESTINO"] || envio.destino || 'N/A'}</p>
                                <p><span class="font-medium">Tel√©fono:</span> ${envio["TELEFONOCLIENTE"] || envio.telefonoCliente || 'N/A'}</p>
                                <p><span class="font-medium">Direcci√≥n:</span> ${envio["DIRECCION DESTINO"] || envio.direccionDestino || 'N/A'}</p>
                                <p><span class="font-medium">Barrio:</span> ${envio["BARRIO"] || envio.barrio || 'N/A'}</p>
                                <p><span class="font-medium">Localidad:</span> ${envio["LOCALIDAD"] || envio.localidad || 'N/A'}</p>
                                <p><span class="font-medium">Ciudad:</span> ${envio["CIUDAD DESTINO"] || envio.ciudadDestino || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de Pago -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">payments</span>
                                Informaci√≥n de Pago
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Forma de pago:</span> ${formaPagoTexto}</p>
                                <p><span class="font-medium">Valor a recaudar:</span> $${(envio.valorRecaudar || 0).toLocaleString('es-CO')}</p>
                                <p><span class="font-medium">Total a pagar:</span> <span class="font-bold text-green-600">$${(envio.totalPagar || 0).toLocaleString('es-CO')}</span></p>
                                <p><span class="font-medium">Estado pago:</span> <span class="font-bold ${estadoPagoColor}">${estadoPagoTexto}</span></p>
                                ${fechaPagoTexto ? `<p><span class="font-medium">Fecha pago:</span> ${fechaPagoTexto}</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n Log√≠stica -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">local_shipping</span>
                                Informaci√≥n Log√≠stica
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Mensajero:</span> ${envio["MENSAJERO"] || envio.mensajero || 'Por asignar'}</p>
                                <p><span class="font-medium">Usuario ID:</span> ${envio["USUARIO ID"] || envio.usuarioId || 'N/A'}</p>
                                <p><span class="font-medium">Observaciones:</span> ${envio["OBS"] || envio.observaciones || 'Ninguna'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-2">
                        <button onclick="imprimirGuia('${envioId.replace(/'/g, "\\'")}')" 
                                class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-symbols-outlined">print</span>
                            Imprimir Gu√≠a
                        </button>
                        <button onclick="copiarEnlace('${envioId.replace(/'/g, "\\'")}')" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-symbols-outlined">link</span>
                            Copiar Enlace
                        </button>
                        <button onclick="cerrarModalDetalles()" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalDetallesContenido').innerHTML = html;
            document.getElementById('modalDetalles').classList.remove('hidden');
            
            // Prevenir scroll del body
            document.body.style.overflow = 'hidden';
        }
        
        function cerrarModalDetalles() {
            document.getElementById('modalDetalles').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        function cerrarModalConfirmacion() {
            document.getElementById('modalConfirmacion').classList.add('hidden');
            document.body.style.overflow = 'auto';
            confirmacionCallback = null;
        }
        
        function imprimirGuia(envioId) {
            try {
                localStorage.setItem('envioParaGuia', envioId);
                window.open('guia.html', '_blank');
                mostrarToast('success', 'Imprimir', 'Abriendo gu√≠a para imprimir...');
            } catch (error) {
                mostrarToast('error', 'Error', 'No se pudo abrir la gu√≠a');
            }
        }
        
        function copiarEnlace(envioId) {
            const url = `${window.location.origin}${window.location.pathname}?envio=${envioId}`;
            navigator.clipboard.writeText(url).then(() => {
                mostrarToast('success', 'Enlace copiado', 'El enlace se copi√≥ al portapapeles');
            }).catch(() => {
                // Fallback para navegadores antiguos
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarToast('success', 'Enlace copiado', 'El enlace se copi√≥ al portapapeles');
            });
        }
        
        function exportarHistorial() {
            if (enviosFiltrados.length === 0) {
                mostrarError('No hay datos para exportar');
                return;
            }
            
            mostrarConfirmacion(
                'Exportar Historial',
                `¬øDesea exportar ${enviosFiltrados.length} env√≠os a formato CSV?`,
                () => {
                    // Crear CSV
                    let csv = 'ID,Fecha,Destinatario,Barrio,Forma Pago,Valor a Recaudar,Total a Pagar,Estado,Remitente,Tel√©fono\n';
                    
                    enviosFiltrados.forEach(envio => {
                        const fecha = obtenerFechaEnvio(envio);
                        const fechaFormateada = fecha.toLocaleDateString('es-CO');
                        const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                        const estado = estaPagado ? 'Pagado' : 'Pendiente';
                        
                        csv += `"${envio["ENVIO ID"] || ''}","${fechaFormateada}","${envio["DESTINO"] || ''}","${envio["BARRIO"] || ''}","${envio["FORMA DE PAGO"] || ''}","${envio.valorRecaudar || 0}","${envio.totalPagar || 0}","${estado}","${envio["REMITE"] || ''}","${envio["TELEFONO"] || ''}"\n`;
                    });
                    
                    // Crear y descargar archivo
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    const fechaExportacion = new Date().toISOString().split('T')[0];
                    link.setAttribute('href', url);
                    link.setAttribute('download', `historial_${usuarioActual.USUARIO}_${fechaExportacion}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    mostrarToast('success', 'Exportaci√≥n exitosa', 'El archivo CSV se ha descargado');
                }
            );
        }
        
        function limpiarFiltros() {
            // Establecer fechas por defecto (√∫ltimos 30 d√≠as)
            const hoy = new Date();
            const hace30Dias = new Date();
            hace30Dias.setDate(hoy.getDate() - 30);
            
            const hoyFormato = hoy.toISOString().split('T')[0];
            const hace30DiasFormato = hace30Dias.toISOString().split('T')[0];
            
            document.getElementById('fechaDesde').value = hace30DiasFormato;
            document.getElementById('fechaHasta').value = hoyFormato;
            document.getElementById('formaPagoFilter').value = 'todas';
            document.getElementById('estadoPagoFilter').value = 'todos';
            document.getElementById('busqueda').value = '';
            document.getElementById('ordenarPor').value = 'fecha_desc';
            
            enviosFiltrados = [...todosEnvios];
            ordenarEnvios();
            actualizarEstadisticas();
            
            mostrarToast('info', 'Filtros limpiados', 'Se mostraron todos los env√≠os');
        }
        
        function mostrarConfirmacion(titulo, mensaje, callback) {
            document.getElementById('confirmacionMensaje').textContent = mensaje;
            confirmacionCallback = callback;
            
            document.getElementById('modalConfirmacion').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            document.getElementById('btnConfirmarAccion').onclick = () => {
                cerrarModalConfirmacion();
                if (confirmacionCallback) {
                    confirmacionCallback();
                }
            };
        }
        
        function mostrarToast(tipo, titulo, mensaje) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            // Configurar icono y colores seg√∫n el tipo
            let icono = 'info';
            let color = 'text-blue-500';
            
            switch(tipo) {
                case 'success':
                    icono = 'check_circle';
                    color = 'text-green-500';
                    break;
                case 'error':
                    icono = 'error';
                    color = 'text-red-500';
                    break;
                case 'warning':
                    icono = 'warning';
                    color = 'text-yellow-500';
                    break;
                case 'info':
                default:
                    icono = 'info';
                    color = 'text-blue-500';
            }
            
            toastIcon.textContent = icono;
            toastIcon.className = `material-symbols-outlined mr-3 ${color}`;
            toastTitle.textContent = titulo;
            toastMessage.textContent = mensaje;
            
            toast.classList.remove('hidden');
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                cerrarToast();
            }, 5000);
        }
        
        function cerrarToast() {
            document.getElementById('toast').classList.add('hidden');
        }
        
        function mostrarError(mensaje) {
            mostrarToast('error', 'Error', mensaje);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
    <script src="check-auth.js"></script>
</body>
</html>
