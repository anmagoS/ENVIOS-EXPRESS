
<!DOCTYPE html>
<html class="light" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Historial de Env√≠os</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%233B82F6%22/><path d=%22M30 40 L70 40 L80 60 L20 60 Z%22 fill=%22white%22/><circle cx=%2250%22 cy=%2275%22 r=%228%22 fill=%22white%22/></svg>">
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-dark": "#0f4bc4",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1a202c",
                        "success": "#10b981",
                        "warning": "#f59e0b",
                        "danger": "#ef4444"
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    }
                },
            },
        }
    </script>
    
    <style>
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .badge-pagado { background-color: #10b981; color: white; }
        .badge-pendiente { background-color: #f59e0b; color: white; }
        .badge-sin-pago { background-color: #ef4444; color: white; }
        
        .badge-admin { background-color: #8b5cf6; color: white; }
        .badge-cliente { background-color: #3b82f6; color: white; }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        .dark ::-webkit-scrollbar-thumb { background: #6b7280; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display min-h-screen text-gray-800 dark:text-gray-200">
    
    <!-- Loading screen -->
    <div id="loadingScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white dark:bg-gray-900">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary mb-6"></div>
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2">Cargando historial</h2>
            <p class="text-gray-600 dark:text-gray-400" id="loadingText">Por favor espera...</p>
        </div>
    </div>
    
    <!-- Main content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="sticky top-0 z-40 w-full bg-surface-light dark:bg-surface-dark border-b border-gray-200 dark:border-gray-800 px-6 py-3 shadow-sm">
            <div class="mx-auto max-w-7xl flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="index.html" class="flex items-center justify-center size-10 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Volver al inicio">
                        <span class="material-symbols-outlined text-primary">arrow_back</span>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold" id="tituloPagina">üìã Historial de Env√≠os</h1>
                        <div class="flex items-center gap-2 mt-1">
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="usuarioInfo">Cargando informaci√≥n...</p>
                            <span id="badgeRol" class="text-xs px-2 py-0.5 rounded-full hidden"></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btnRefresh" class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Actualizar">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">refresh</span>
                    </button>
                    
                    <button id="btnDarkMode" class="flex items-center justify-center size-10 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Modo oscuro">
                        <span class="material-symbols-outlined text-gray-600 dark:text-gray-400" id="darkModeIcon">dark_mode</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Main content -->
        <main class="w-full px-4 py-6 md:px-6 lg:px-8">
            <div class="max-w-7xl mx-auto">
                
                <!-- Secci√≥n de filtros (cambia seg√∫n rol) -->
                <div id="filtrosCliente" class="hidden">
                    <!-- Filtros para CLIENTE (simplificados) -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">filter_alt</span>
                                Mis Env√≠os - Filtros
                            </h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <!-- Filtro por Forma de Pago -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">payments</span>
                                    Forma de Pago
                                </label>
                                <select id="formaPagoFilterCliente" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todas">Todas</option>
                                    <option value="contado">Contado</option>
                                    <option value="contraentrega">Contraentrega</option>
                                    <option value="contraentrega_recaudo">Con Recaudo</option>
                                </select>
                            </div>
                            
                            <!-- Filtro por Estado de Pago -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">check_circle</span>
                                    Estado Pago
                                </label>
                                <select id="estadoPagoFilterCliente" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todos">Todos los estados</option>
                                    <option value="pagado">Pagados</option>
                                    <option value="pendiente">Pendientes</option>
                                    <option value="sin_pago">Sin pago</option>
                                </select>
                            </div>
                            
                            <!-- Filtro por Mensajero -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">local_shipping</span>
                                    Mensajero
                                </label>
                                <select id="mensajeroFilterCliente" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todos">Todos los mensajeros</option>
                                    <option value="Sin asignar">Sin asignar</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Segunda fila: B√∫squeda -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">search</span>
                                    Buscar env√≠os
                                </label>
                                <input type="text" id="busquedaCliente" 
                                       placeholder="Buscar por ID, Destinatario, Barrio..." 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="aplicarFiltrosCliente()" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap">
                                    <span class="material-symbols-outlined text-sm">search</span>
                                    Aplicar
                                </button>
                                <button onclick="limpiarFiltrosCliente()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-sm transition-colors whitespace-nowrap">
                                    Limpiar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="filtrosAdmin" class="hidden">
                    <!-- Filtros para ADMIN (completos) -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold flex items-center gap-2">
                                <span class="material-symbols-outlined text-primary">filter_alt</span>
                                Filtros Avanzados - Administrador
                            </h3>
                            <div class="flex items-center gap-2">
                                <span id="estadoFiltros" class="text-xs px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded">
                                    Sin filtros
                                </span>
                            </div>
                        </div>
                        
                        <!-- Primera fila de filtros -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                            <!-- Filtro por Usuario -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">person</span>
                                    Usuario ID
                                </label>
                                <select id="usuarioFilterAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todos">Todos los usuarios</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Filtro por Mensajero -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">local_shipping</span>
                                    Mensajero
                                </label>
                                <select id="mensajeroFilterAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todos">Todos los mensajeros</option>
                                    <option value="Sin asignar">Sin asignar</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Filtro por Ciudad Destino -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">location_city</span>
                                    Ciudad Destino
                                </label>
                                <select id="ciudadFilterAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todas">Todas las ciudades</option>
                                    <option value="Bogot√° D.C.">Bogot√° D.C.</option>
                                    <option value="Soacha">Soacha</option>
                                    <!-- Se llena din√°micamente -->
                                </select>
                            </div>
                            
                            <!-- Filtro por Forma de Pago -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">payments</span>
                                    Forma de Pago
                                </label>
                                <select id="formaPagoFilterAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todas">Todas</option>
                                    <option value="contado">Contado</option>
                                    <option value="contraentrega">Contraentrega</option>
                                    <option value="contraentrega_recaudo">Con Recaudo</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Segunda fila de filtros -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <!-- Rango de fechas -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">calendar_today</span>
                                    Fecha desde
                                </label>
                                <input type="date" id="fechaDesdeAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">event_available</span>
                                    Fecha hasta
                                </label>
                                <input type="date" id="fechaHastaAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <!-- Estado de Pago -->
                            <div>
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">check_circle</span>
                                    Estado Pago
                                </label>
                                <select id="estadoPagoFilterAdmin" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                    <option value="todos">Todos los estados</option>
                                    <option value="pagado">Pagados</option>
                                    <option value="pendiente">Pendientes</option>
                                    <option value="sin_pago">Sin pago</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Tercera fila: B√∫squeda y botones -->
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div class="flex-1">
                                <label class="block text-sm font-medium mb-1">
                                    <span class="material-symbols-outlined text-sm align-text-bottom mr-1">search</span>
                                    B√∫squeda avanzada
                                </label>
                                <input type="text" id="busquedaAdmin" 
                                       placeholder="Buscar por ID, Destinatario, Barrio, Direcci√≥n, Tel√©fono..." 
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="aplicarFiltrosAdmin()" class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap">
                                    <span class="material-symbols-outlined text-sm">search</span>
                                    Aplicar Filtros
                                </button>
                                <button onclick="limpiarFiltrosAdmin()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 text-sm transition-colors whitespace-nowrap">
                                    Limpiar Todo
                                </button>
                                <button onclick="exportarExcel()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 transition-colors whitespace-nowrap">
                                    <span class="material-symbols-outlined text-sm">download</span>
                                    Exportar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tarjetas de estad√≠sticas (cambian seg√∫n rol) -->
                <div id="estadisticasCliente" class="hidden">
                    <!-- Estad√≠sticas para CLIENTE -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Mis Env√≠os</p>
                                    <p class="text-2xl font-bold" id="totalEnviosCliente">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-blue-500">local_shipping</span>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Pendiente a Pagar</p>
                                    <p class="text-2xl font-bold text-green-600" id="totalPagarCliente">$0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-green-500">payments</span>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Total a Recaudar</p>
                                    <p class="text-2xl font-bold text-orange-600" id="totalRecaudarCliente">$0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-orange-500">attach_money</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="estadisticasAdmin" class="hidden">
                    <!-- Estad√≠sticas para ADMIN -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Total Env√≠os</p>
                                    <p class="text-2xl font-bold" id="totalEnviosAdmin">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-blue-500">local_shipping</span>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Usuarios Activos</p>
                                    <p class="text-2xl font-bold text-purple-600" id="totalUsuariosAdmin">0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-purple-500">groups</span>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Pendiente a Pagar</p>
                                    <p class="text-2xl font-bold text-green-600" id="totalPagarAdmin">$0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-green-500">payments</span>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Total a Recaudar</p>
                                    <p class="text-2xl font-bold text-orange-600" id="totalRecaudarAdmin">$0</p>
                                </div>
                                <span class="material-symbols-outlined text-3xl text-orange-500">attach_money</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de env√≠os (com√∫n para ambos) -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                        <h3 class="font-bold flex items-center gap-2">
                            <span class="material-symbols-outlined text-primary">list_alt</span>
                            <span id="tituloTabla">Env√≠os Registrados</span>
                            <span class="text-sm font-normal text-gray-600 dark:text-gray-400 ml-2" id="contadorEnvios">(0 env√≠os)</span>
                        </h3>
                        <div class="flex items-center gap-2">
                            <select id="ordenarPor" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-lg text-sm dark:bg-gray-700 dark:text-white">
                                <option value="fecha_desc">M√°s recientes</option>
                                <option value="fecha_asc">M√°s antiguos</option>
                                <option value="valor_desc">Mayor valor</option>
                                <option value="valor_asc">Menor valor</option>
                                <option value="destino_asc">Destino (A-Z)</option>
                                <option value="destino_desc">Destino (Z-A)</option>
                            </select>
                            <button id="btnActualizarDatos" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">sync</span>
                                Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr id="cabeceraTabla">
                                    <!-- Se llena din√°micamente seg√∫n rol -->
                                </tr>
                            </thead>
                            <tbody id="tablaEnvios" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- Se llena con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sin resultados -->
                    <div id="sinResultados" class="hidden p-8 text-center">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">inbox</span>
                        <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300" id="tituloSinResultados">No hay env√≠os registrados</h4>
                        <p class="text-gray-500 dark:text-gray-400 mt-1" id="mensajeSinResultados">No se encontraron env√≠os con los filtros aplicados</p>
                        <button onclick="limpiarFiltros()" class="mt-4 px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm font-medium">
                            Resetear filtros
                        </button>
                    </div>
                    
                    <!-- Loading tabla -->
                    <div id="tablaLoading" class="p-8 text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary mb-2"></div>
                        <p class="text-gray-500 dark:text-gray-400">Cargando env√≠os...</p>
                    </div>
                    
                    <!-- Paginaci√≥n -->
                    <div id="paginacion" class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 hidden">
                        <div class="flex items-center justify-between">
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                Mostrando <span id="paginaInicio">1</span>-<span id="paginaFin">10</span> de <span id="totalItems">0</span>
                            </div>
                            <div class="flex gap-1">
                                <button id="btnAnterior" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                    ‚Üê Anterior
                                </button>
                                <span class="px-3 py-1 text-sm text-gray-600 dark:text-gray-400" id="paginaActual">1</span>
                                <button id="btnSiguiente" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
                                    Siguiente ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal detalles -->
    <div id="modalDetalles" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" id="modalBackdrop"></div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="px-6 py-4 bg-primary text-white">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">üìÑ Detalles del Env√≠o</h3>
                        <button onclick="cerrarModalDetalles()" class="text-white hover:text-gray-200 transition-colors">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4 max-h-[70vh] overflow-y-auto">
                    <div id="modalDetallesContenido">
                        <!-- Cargado din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaci√≥n toast -->
    <div id="toast" class="fixed top-4 right-4 z-[120] hidden">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm">
            <div class="flex items-start">
                <span class="material-symbols-outlined mr-3" id="toastIcon">info</span>
                <div class="flex-1">
                    <h4 class="font-bold" id="toastTitle">Notificaci√≥n</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1" id="toastMessage"></p>
                </div>
                <button onclick="cerrarToast()" class="ml-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <span class="material-symbols-outlined text-sm">close</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        // Configuraci√≥n
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxIipuPmVAvaTt7_oUQzMLNtXIah19dcq2CWkaoglQvFivqY-wBYEw64tvUmL4-1k62/exec";
        
        // Variables globales
        let usuarioActual = null;
        let esAdmin = false;
        let todosEnvios = [];
        let enviosFiltrados = [];
        let paginaActual = 1;
        const itemsPorPagina = 15;
        
        // Listas para filtros (solo admin)
        let listaUsuarios = [];
        let listaMensajeros = [];
        let listaCiudades = [];
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            inicializarAplicacion();
        });
        
        function inicializarAplicacion() {
            // 1. Determinar usuario y rol
            determinarUsuarioYRol();
            
            // 2. Configurar eventos
            configurarEventos();
            
            // 3. Configurar modo oscuro
            configurarModoOscuro();
            
            // 4. Configurar interfaz seg√∫n rol
            configurarInterfazPorRol();
            
            // 5. Cargar datos iniciales
            cargarDatosIniciales();
        }
        
        function determinarUsuarioYRol() {
            try {
                // Obtener usuario de localStorage
                const usuarioStorage = localStorage.getItem('usuarioLogueado');
                if (!usuarioStorage) {
                    window.location.href = 'login.html';
                    return;
                }
                
                usuarioActual = JSON.parse(usuarioStorage);
                esAdmin = usuarioActual.ROL === 'ADMIN';
                
                console.log(`üë§ Usuario: ${usuarioActual.USUARIO}, Rol: ${usuarioActual.ROL}, Admin: ${esAdmin}`);
                
            } catch (error) {
                console.error('Error determinando usuario:', error);
                mostrarError('Error al identificar usuario: ' + error.message);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        }
        
        function configurarInterfazPorRol() {
            // Actualizar t√≠tulo y badge seg√∫n rol
            const tituloPagina = document.getElementById('tituloPagina');
            const usuarioInfo = document.getElementById('usuarioInfo');
            const badgeRol = document.getElementById('badgeRol');
            
            if (esAdmin) {
                tituloPagina.textContent = 'üìã Historial de Env√≠os - Administrador';
                badgeRol.textContent = 'ADMIN';
                badgeRol.className = 'text-xs px-2 py-0.5 rounded-full badge-admin';
                usuarioInfo.textContent = `${usuarioActual["NOMBRE COMPLETO"] || usuarioActual.USUARIO} ‚Ä¢ Administrador`;
                document.title = `Historial Admin - ${usuarioActual.USUARIO}`;
                
                // Mostrar secciones de admin
                document.getElementById('filtrosAdmin').classList.remove('hidden');
                document.getElementById('estadisticasAdmin').classList.remove('hidden');
                
                // Configurar fechas por defecto para admin
                configurarFechasPorDefecto();
                
            } else {
                tituloPagina.textContent = 'üìã Mis Env√≠os';
                badgeRol.textContent = 'CLIENTE';
                badgeRol.className = 'text-xs px-2 py-0.5 rounded-full badge-cliente';
                usuarioInfo.textContent = `${usuarioActual["NOMBRE COMPLETO"] || usuarioActual.USUARIO}`;
                document.title = `Mis Env√≠os - ${usuarioActual.USUARIO}`;
                
                // Mostrar secciones de cliente
                document.getElementById('filtrosCliente').classList.remove('hidden');
                document.getElementById('estadisticasCliente').classList.remove('hidden');
            }
            
            badgeRol.classList.remove('hidden');
            
            // Configurar cabecera de tabla seg√∫n rol
            configurarCabeceraTabla();
        }
        
        function configurarCabeceraTabla() {
            const cabecera = document.getElementById('cabeceraTabla');
            const tituloTabla = document.getElementById('tituloTabla');
            
            if (esAdmin) {
                tituloTabla.textContent = 'Todos los Env√≠os';
                cabecera.innerHTML = `
                    <th class="py-3 px-4 text-left text-sm font-medium">ID Gu√≠a</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Fecha</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Usuario</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Destinatario</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Forma Pago</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Valor</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Total Pagar</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Mensajero</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Estado</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Acciones</th>
                `;
            } else {
                tituloTabla.textContent = 'Mis Env√≠os';
                cabecera.innerHTML = `
                    <th class="py-3 px-4 text-left text-sm font-medium">ID Gu√≠a</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Fecha</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Destinatario</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Forma Pago</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Valor</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Total Pagar</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Mensajero</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Estado</th>
                    <th class="py-3 px-4 text-left text-sm font-medium">Acciones</th>
                `;
            }
        }
        
        function configurarEventos() {
            // Botones comunes
            document.getElementById('btnRefresh').addEventListener('click', cargarDatosIniciales);
            document.getElementById('btnActualizarDatos').addEventListener('click', cargarDatosIniciales);
            document.getElementById('btnDarkMode').addEventListener('click', toggleModoOscuro);
            
            // Ordenar
            document.getElementById('ordenarPor').addEventListener('change', function() {
                ordenarEnvios();
            });
            
            // Paginaci√≥n
            document.getElementById('btnAnterior').addEventListener('click', () => cambiarPagina(-1));
            document.getElementById('btnSiguiente').addEventListener('click', () => cambiarPagina(1));
            
            // Modal
            document.getElementById('modalBackdrop').addEventListener('click', cerrarModalDetalles);
            
            // Tecla Escape para cerrar modales
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    cerrarModalDetalles();
                    cerrarToast();
                }
            });
            
            // Eventos espec√≠ficos para admin
            if (esAdmin) {
                // Filtros admin
                document.getElementById('busquedaAdmin').addEventListener('input', debounce(aplicarFiltrosAdmin, 300));
                document.getElementById('usuarioFilterAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('mensajeroFilterAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('ciudadFilterAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('formaPagoFilterAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('estadoPagoFilterAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('fechaDesdeAdmin').addEventListener('change', aplicarFiltrosAdmin);
                document.getElementById('fechaHastaAdmin').addEventListener('change', aplicarFiltrosAdmin);
            } else {
                // Filtros cliente
                document.getElementById('busquedaCliente').addEventListener('input', debounce(aplicarFiltrosCliente, 300));
                document.getElementById('formaPagoFilterCliente').addEventListener('change', aplicarFiltrosCliente);
                document.getElementById('estadoPagoFilterCliente').addEventListener('change', aplicarFiltrosCliente);
                document.getElementById('mensajeroFilterCliente').addEventListener('change', aplicarFiltrosCliente);
            }
        }
        
        function configurarModoOscuro() {
            const modoOscuro = localStorage.getItem('modoOscuro') === 'true';
            
            if (modoOscuro) {
                document.documentElement.classList.add('dark');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
            }
        }
        
        function configurarFechasPorDefecto() {
            const hoy = new Date();
            const hace7Dias = new Date();
            hace7Dias.setDate(hoy.getDate() - 7);
            
            const formatoFecha = (fecha) => fecha.toISOString().split('T')[0];
            
            document.getElementById('fechaDesdeAdmin').value = formatoFecha(hace7Dias);
            document.getElementById('fechaHastaAdmin').value = formatoFecha(hoy);
        }
        
        function toggleModoOscuro() {
            const tieneModoOscuro = document.documentElement.classList.contains('dark');
            
            if (tieneModoOscuro) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('modoOscuro', 'false');
                document.getElementById('darkModeIcon').textContent = 'dark_mode';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('modoOscuro', 'true');
                document.getElementById('darkModeIcon').textContent = 'light_mode';
            }
        }
        
        async function cargarDatosIniciales() {
            try {
                // Mostrar loading
                document.getElementById('loadingScreen').classList.remove('hidden');
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('tablaLoading').classList.remove('hidden');
                document.getElementById('sinResultados').classList.add('hidden');
                document.getElementById('tablaEnvios').innerHTML = '';
                
                console.log(`üîÑ Cargando datos para ${esAdmin ? 'ADMIN' : 'CLIENTE'}: ${usuarioActual.USUARIO}`);
                
                if (esAdmin) {
                    // Admin: cargar TODOS los env√≠os
                    await cargarTodosLosEnviosAdmin();
                    extraerListasFiltrosAdmin();
                    actualizarSelectsFiltrosAdmin();
                    aplicarFiltrosAdmin();
                } else {
                    // Cliente: cargar solo sus env√≠os
                    await cargarEnviosCliente();
                    extraerListasFiltrosCliente();
                    actualizarSelectsFiltrosCliente();
                    aplicarFiltrosCliente();
                }
                
                mostrarToast('success', 'Datos cargados', `Se cargaron ${todosEnvios.length} env√≠os`);
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                mostrarError('Error al cargar datos: ' + error.message);
            } finally {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('tablaLoading').classList.add('hidden');
            }
        }
        
        // ============================================
        // FUNCIONES PARA ADMIN
        // ============================================
        
        async function cargarTodosLosEnviosAdmin() {
            try {
                console.log('üì° Admin: Cargando TODOS los env√≠os...');
                
                const url = `${WEB_APP_URL}?action=getAllEnvios`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos (admin):', data);
                
                if (data.success && Array.isArray(data.data)) {
                    todosEnvios = data.data.map(envio => ({
                        ...envio,
                        valorRecaudar: parseFloat(envio["VALOR A RECAUDAR"] || 0),
                        totalPagar: parseFloat(envio["TOTAL A PAGAR"] || 0)
                    }));
                    
                    console.log(`‚úÖ ${todosEnvios.length} env√≠os cargados para administrador`);
                    
                } else {
                    console.log('‚ö†Ô∏è Respuesta vac√≠a o no es array');
                    todosEnvios = [];
                }
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error cargando desde API:', error.message);
                todosEnvios = [];
            }
        }
        
        function extraerListasFiltrosAdmin() {
            const usuariosSet = new Set();
            const mensajerosSet = new Set();
            const ciudadesSet = new Set();
            
            todosEnvios.forEach(envio => {
                // Usuarios
                const usuario = envio["USUARIO ID"] || '';
                if (usuario) usuariosSet.add(usuario.trim());
                
                // Mensajeros
                const mensajero = envio["MENSAJERO"] || '';
                if (mensajero && mensajero !== 'Por asignar') {
                    mensajerosSet.add(mensajero.trim());
                }
                
                // Ciudades
                const ciudad = envio["CIUDAD DESTINO"] || '';
                if (ciudad) ciudadesSet.add(ciudad.trim());
            });
            
            listaUsuarios = Array.from(usuariosSet).sort();
            listaMensajeros = Array.from(mensajerosSet).sort();
            listaCiudades = Array.from(ciudadesSet).sort();
            
            console.log(`üìä Filtros admin extra√≠dos: ${listaUsuarios.length} usuarios, ${listaMensajeros.length} mensajeros, ${listaCiudades.length} ciudades`);
        }
        
        function actualizarSelectsFiltrosAdmin() {
            // Usuarios
            const selectUsuario = document.getElementById('usuarioFilterAdmin');
            selectUsuario.innerHTML = '<option value="todos">Todos los usuarios</option>';
            listaUsuarios.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario;
                option.textContent = usuario;
                selectUsuario.appendChild(option);
            });
            
            // Mensajeros
            const selectMensajero = document.getElementById('mensajeroFilterAdmin');
            selectMensajero.innerHTML = '<option value="todos">Todos los mensajeros</option>';
            selectMensajero.innerHTML += '<option value="Sin asignar">Sin asignar</option>';
            listaMensajeros.forEach(mensajero => {
                const option = document.createElement('option');
                option.value = mensajero;
                option.textContent = mensajero;
                selectMensajero.appendChild(option);
            });
            
            // Ciudades
            const selectCiudad = document.getElementById('ciudadFilterAdmin');
            selectCiudad.innerHTML = '<option value="todas">Todas las ciudades</option>';
            listaCiudades.forEach(ciudad => {
                const option = document.createElement('option');
                option.value = ciudad;
                option.textContent = ciudad;
                selectCiudad.appendChild(option);
            });
        }
        
        function aplicarFiltrosAdmin() {
            const usuarioSeleccionado = document.getElementById('usuarioFilterAdmin').value;
            const mensajeroSeleccionado = document.getElementById('mensajeroFilterAdmin').value;
            const ciudadSeleccionada = document.getElementById('ciudadFilterAdmin').value;
            const formaPago = document.getElementById('formaPagoFilterAdmin').value;
            const estadoPago = document.getElementById('estadoPagoFilterAdmin').value;
            const fechaDesde = document.getElementById('fechaDesdeAdmin').value;
            const fechaHasta = document.getElementById('fechaHastaAdmin').value;
            const busqueda = document.getElementById('busquedaAdmin').value.toLowerCase().trim();
            
            // Filtrar env√≠os
            enviosFiltrados = todosEnvios.filter(envio => {
                let cumple = true;
                
                // 1. Usuario
                if (usuarioSeleccionado !== 'todos') {
                    const usuarioEnvio = (envio["USUARIO ID"] || '').trim();
                    cumple = cumple && (usuarioEnvio === usuarioSeleccionado);
                }
                
                // 2. Mensajero
                if (mensajeroSeleccionado !== 'todos') {
                    const mensajeroEnvio = (envio["MENSAJERO"] || '').trim();
                    if (mensajeroSeleccionado === 'Sin asignar') {
                        cumple = cumple && (!mensajeroEnvio || mensajeroEnvio === 'Por asignar');
                    } else {
                        cumple = cumple && (mensajeroEnvio === mensajeroSeleccionado);
                    }
                }
                
                // 3. Ciudad
                if (ciudadSeleccionada !== 'todas') {
                    const ciudadEnvio = (envio["CIUDAD DESTINO"] || '').trim();
                    cumple = cumple && (ciudadEnvio === ciudadSeleccionada);
                }
                
                // 4. Forma de pago
                if (formaPago !== 'todas') {
                    const formaPagoEnvio = (envio["FORMA DE PAGO"] || '').toLowerCase();
                    if (formaPago === 'contraentrega_recaudo') {
                        cumple = cumple && formaPagoEnvio.includes('recaudo');
                    } else {
                        cumple = cumple && (formaPagoEnvio === formaPago);
                    }
                }
                
                // 5. Estado de pago
                if (estadoPago !== 'todos') {
                    const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                    const totalPagar = envio.totalPagar || 0;
                    
                    switch(estadoPago) {
                        case 'pagado': cumple = cumple && estaPagado; break;
                        case 'pendiente': cumple = cumple && !estaPagado && totalPagar > 0; break;
                        case 'sin_pago': cumple = cumple && totalPagar === 0; break;
                    }
                }
                
                // 6. Rango de fechas
                if (fechaDesde || fechaHasta) {
                    const fechaEnvio = parsearFechaEnvio(envio["FECHA DE CREACION"]);
                    if (fechaEnvio) {
                        if (fechaDesde) {
                            const desde = new Date(fechaDesde);
                            cumple = cumple && (fechaEnvio >= desde);
                        }
                        if (fechaHasta) {
                            const hasta = new Date(fechaHasta);
                            hasta.setDate(hasta.getDate() + 1);
                            cumple = cumple && (fechaEnvio < hasta);
                        }
                    }
                }
                
                // 7. B√∫squeda
                if (busqueda) {
                    const camposBusqueda = [
                        envio["ENVIO ID"] || '',
                        envio["DESTINO"] || '',
                        envio["BARRIO"] || '',
                        envio["REMITE"] || '',
                        envio["USUARIO ID"] || ''
                    ];
                    
                    const coincide = camposBusqueda.some(campo => 
                        campo.toString().toLowerCase().includes(busqueda)
                    );
                    cumple = cumple && coincide;
                }
                
                return cumple;
            });
            
            console.log(`‚úÖ Admin: ${enviosFiltrados.length} env√≠os despu√©s de filtrar`);
            
            // Actualizar estado de filtros
            actualizarEstadoFiltrosAdmin();
            
            // Mostrar resultados
            ordenarEnvios();
            paginaActual = 1;
            mostrarPagina();
            actualizarEstadisticasAdmin();
        }
        
        function actualizarEstadoFiltrosAdmin() {
            const filtrosActivos = [];
            
            if (document.getElementById('usuarioFilterAdmin').value !== 'todos') filtrosActivos.push('Usuario');
            if (document.getElementById('mensajeroFilterAdmin').value !== 'todos') filtrosActivos.push('Mensajero');
            if (document.getElementById('ciudadFilterAdmin').value !== 'todas') filtrosActivos.push('Ciudad');
            if (document.getElementById('formaPagoFilterAdmin').value !== 'todas') filtrosActivos.push('Forma Pago');
            if (document.getElementById('estadoPagoFilterAdmin').value !== 'todos') filtrosActivos.push('Estado Pago');
            if (document.getElementById('fechaDesdeAdmin').value || document.getElementById('fechaHastaAdmin').value) filtrosActivos.push('Fecha');
            if (document.getElementById('busquedaAdmin').value) filtrosActivos.push('B√∫squeda');
            
            const estadoElement = document.getElementById('estadoFiltros');
            if (filtrosActivos.length > 0) {
                estadoElement.textContent = `${filtrosActivos.length} filtro(s) activo(s)`;
                estadoElement.className = 'text-xs px-2 py-1 bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 rounded';
            } else {
                estadoElement.textContent = 'Sin filtros';
                estadoElement.className = 'text-xs px-2 py-1 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded';
            }
        }
        
        function limpiarFiltrosAdmin() {
            document.getElementById('usuarioFilterAdmin').value = 'todos';
            document.getElementById('mensajeroFilterAdmin').value = 'todos';
            document.getElementById('ciudadFilterAdmin').value = 'todas';
            document.getElementById('formaPagoFilterAdmin').value = 'todas';
            document.getElementById('estadoPagoFilterAdmin').value = 'todos';
            document.getElementById('busquedaAdmin').value = '';
            document.getElementById('ordenarPor').value = 'fecha_desc';
            configurarFechasPorDefecto();
            
            aplicarFiltrosAdmin();
            mostrarToast('info', 'Filtros limpiados', 'Se mostraron todos los env√≠os');
        }
        
        function actualizarEstadisticasAdmin() {
            const totalEnvios = enviosFiltrados.length;
            
            if (totalEnvios === 0) {
                document.getElementById('totalEnviosAdmin').textContent = '0';
                document.getElementById('totalUsuariosAdmin').textContent = '0';
                document.getElementById('totalPagarAdmin').textContent = '$0';
                document.getElementById('totalRecaudarAdmin').textContent = '$0';
                return;
            }
            
            let totalPagar = 0;
            let totalRecaudar = 0;
            const usuariosSet = new Set();
            
            enviosFiltrados.forEach(envio => {
                const valorPagar = envio.totalPagar || 0;
                const valorRecaudar = envio.valorRecaudar || 0;
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                const usuario = envio["USUARIO ID"] || '';
                
                if (!estaPagado && valorPagar > 0) {
                    totalPagar += valorPagar;
                }
                
                totalRecaudar += valorRecaudar;
                if (usuario) usuariosSet.add(usuario);
            });
            
            document.getElementById('totalEnviosAdmin').textContent = totalEnvios.toLocaleString();
            document.getElementById('totalUsuariosAdmin').textContent = usuariosSet.size.toLocaleString();
            document.getElementById('totalPagarAdmin').textContent = `$${totalPagar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            document.getElementById('totalRecaudarAdmin').textContent = `$${totalRecaudar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
        }
        
        // ============================================
        // FUNCIONES PARA CLIENTE
        // ============================================
        
        async function cargarEnviosCliente() {
            try {
                console.log('üì° Cliente: Cargando env√≠os del usuario...');
                
                const url = `${WEB_APP_URL}?action=getHistorialCliente&usuarioId=${encodeURIComponent(usuarioActual.USUARIO)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('üìä Datos recibidos (cliente):', data);
                
                if (data && Array.isArray(data)) {
                    todosEnvios = data.map(envio => ({
                        ...envio,
                        valorRecaudar: parseFloat(envio["VALOR A RECAUDAR"] || envio.valorRecaudar || 0),
                        totalPagar: parseFloat(envio["TOTAL A PAGAR"] || envio.totalPagar || 0),
                        // Asegurar que tenga el usuario correcto
                        "USUARIO ID": usuarioActual.USUARIO
                    }));
                    
                    console.log(`‚úÖ Cliente: ${todosEnvios.length} env√≠os cargados para ${usuarioActual.USUARIO}`);
                    
                } else {
                    console.log('‚ö†Ô∏è Respuesta vac√≠a o no es array');
                    todosEnvios = [];
                }
                
            } catch (error) {
                console.log('‚ö†Ô∏è Error cargando desde API:', error.message);
                todosEnvios = [];
            }
        }
        
        function extraerListasFiltrosCliente() {
            const mensajerosSet = new Set();
            
            todosEnvios.forEach(envio => {
                const mensajero = envio["MENSAJERO"] || '';
                if (mensajero && mensajero !== 'Por asignar') {
                    mensajerosSet.add(mensajero.trim());
                }
            });
            
            listaMensajeros = Array.from(mensajerosSet).sort();
            console.log(`üìä Cliente: ${listaMensajeros.length} mensajeros encontrados`);
        }
        
        function actualizarSelectsFiltrosCliente() {
            const selectMensajero = document.getElementById('mensajeroFilterCliente');
            selectMensajero.innerHTML = '<option value="todos">Todos los mensajeros</option>';
            selectMensajero.innerHTML += '<option value="Sin asignar">Sin asignar</option>';
            
            listaMensajeros.forEach(mensajero => {
                const option = document.createElement('option');
                option.value = mensajero;
                option.textContent = mensajero;
                selectMensajero.appendChild(option);
            });
        }
        
        function aplicarFiltrosCliente() {
            const formaPago = document.getElementById('formaPagoFilterCliente').value;
            const estadoPago = document.getElementById('estadoPagoFilterCliente').value;
            const mensajeroSeleccionado = document.getElementById('mensajeroFilterCliente').value;
            const busqueda = document.getElementById('busquedaCliente').value.toLowerCase().trim();
            
            // Filtrar env√≠os (solo los del cliente)
            enviosFiltrados = todosEnvios.filter(envio => {
                let cumple = true;
                
                // 1. Forma de pago
                if (formaPago !== 'todas') {
                    const formaPagoEnvio = (envio["FORMA DE PAGO"] || '').toLowerCase();
                    if (formaPago === 'contraentrega_recaudo') {
                        cumple = cumple && formaPagoEnvio.includes('recaudo');
                    } else {
                        cumple = cumple && (formaPagoEnvio === formaPago);
                    }
                }
                
                // 2. Estado de pago
                if (estadoPago !== 'todos') {
                    const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                    const totalPagar = envio.totalPagar || 0;
                    
                    switch(estadoPago) {
                        case 'pagado': cumple = cumple && estaPagado; break;
                        case 'pendiente': cumple = cumple && !estaPagado && totalPagar > 0; break;
                        case 'sin_pago': cumple = cumple && totalPagar === 0; break;
                    }
                }
                
                // 3. Mensajero
                if (mensajeroSeleccionado !== 'todos') {
                    const mensajeroEnvio = (envio["MENSAJERO"] || '').trim();
                    if (mensajeroSeleccionado === 'Sin asignar') {
                        cumple = cumple && (!mensajeroEnvio || mensajeroEnvio === 'Por asignar');
                    } else {
                        cumple = cumple && (mensajeroEnvio === mensajeroSeleccionado);
                    }
                }
                
                // 4. B√∫squeda
                if (busqueda) {
                    const camposBusqueda = [
                        envio["ENVIO ID"] || '',
                        envio["DESTINO"] || '',
                        envio["BARRIO"] || '',
                        envio["REMITE"] || ''
                    ];
                    
                    const coincide = camposBusqueda.some(campo => 
                        campo.toString().toLowerCase().includes(busqueda)
                    );
                    cumple = cumple && coincide;
                }
                
                return cumple;
            });
            
            console.log(`‚úÖ Cliente: ${enviosFiltrados.length} env√≠os despu√©s de filtrar`);
            
            // Mostrar resultados
            ordenarEnvios();
            paginaActual = 1;
            mostrarPagina();
            actualizarEstadisticasCliente();
        }
        
        function limpiarFiltrosCliente() {
            document.getElementById('formaPagoFilterCliente').value = 'todas';
            document.getElementById('estadoPagoFilterCliente').value = 'todos';
            document.getElementById('mensajeroFilterCliente').value = 'todos';
            document.getElementById('busquedaCliente').value = '';
            document.getElementById('ordenarPor').value = 'fecha_desc';
            
            aplicarFiltrosCliente();
            mostrarToast('info', 'Filtros limpiados', 'Se mostraron todos tus env√≠os');
        }
        
        function actualizarEstadisticasCliente() {
            const totalEnvios = enviosFiltrados.length;
            
            if (totalEnvios === 0) {
                document.getElementById('totalEnviosCliente').textContent = '0';
                document.getElementById('totalPagarCliente').textContent = '$0';
                document.getElementById('totalRecaudarCliente').textContent = '$0';
                return;
            }
            
            let totalPagar = 0;
            let totalRecaudar = 0;
            
            enviosFiltrados.forEach(envio => {
                const valorPagar = envio.totalPagar || 0;
                const valorRecaudar = envio.valorRecaudar || 0;
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                
                if (!estaPagado && valorPagar > 0) {
                    totalPagar += valorPagar;
                }
                
                totalRecaudar += valorRecaudar;
            });
            
            document.getElementById('totalEnviosCliente').textContent = totalEnvios.toLocaleString();
            document.getElementById('totalPagarCliente').textContent = `$${totalPagar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
            document.getElementById('totalRecaudarCliente').textContent = `$${totalRecaudar.toLocaleString('es-CO', {minimumFractionDigits: 0})}`;
        }
        
        // ============================================
        // FUNCIONES COMUNES
        // ============================================
        
        function determinarSiEstaPagado(estado) {
            if (!estado) return false;
            
            if (typeof estado === 'string') {
                const estadoUpper = estado.toUpperCase().trim();
                return estadoUpper === 'SI' || 
                       estadoUpper === 'TRUE' || 
                       estadoUpper === '1' || 
                       estadoUpper === 'YES' || 
                       estadoUpper === 'PAGADO';
            }
            
            return false;
        }
        
        function parsearFechaEnvio(fechaStr) {
            if (!fechaStr) return null;
            
            try {
                // Formato DD/MM/YYYY HH:MM:SS
                const match = fechaStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
                if (match) {
                    const [, dia, mes, a√±o, hora, minuto, segundo] = match;
                    return new Date(`${a√±o}-${mes}-${dia}T${hora}:${minuto}:${segundo}`);
                }
                
                const fecha = new Date(fechaStr);
                if (!isNaN(fecha.getTime())) {
                    return fecha;
                }
                
                return null;
            } catch (error) {
                console.error('Error parseando fecha:', fechaStr, error);
                return null;
            }
        }
        
        function ordenarEnvios() {
            const orden = document.getElementById('ordenarPor').value;
            
            enviosFiltrados.sort((a, b) => {
                const fechaA = parsearFechaEnvio(a["FECHA DE CREACION"]) || new Date(0);
                const fechaB = parsearFechaEnvio(b["FECHA DE CREACION"]) || new Date(0);
                const valorA = a.totalPagar || 0;
                const valorB = b.totalPagar || 0;
                const destinoA = (a["DESTINO"] || '').toLowerCase();
                const destinoB = (b["DESTINO"] || '').toLowerCase();
                
                switch (orden) {
                    case 'fecha_desc': return fechaB.getTime() - fechaA.getTime();
                    case 'fecha_asc': return fechaA.getTime() - fechaB.getTime();
                    case 'valor_desc': return valorB - valorA;
                    case 'valor_asc': return valorA - valorB;
                    case 'destino_asc': return destinoA.localeCompare(destinoB);
                    case 'destino_desc': return destinoB.localeCompare(destinoA);
                    default: return fechaB.getTime() - fechaA.getTime();
                }
            });
            
            mostrarPagina();
        }
        
        function mostrarPagina() {
            const tbody = document.getElementById('tablaEnvios');
            const sinResultados = document.getElementById('sinResultados');
            const tablaLoading = document.getElementById('tablaLoading');
            const paginacion = document.getElementById('paginacion');
            const contador = document.getElementById('contadorEnvios');
            const tituloSinResultados = document.getElementById('tituloSinResultados');
            const mensajeSinResultados = document.getElementById('mensajeSinResultados');
            
            // Ocultar loading
            tablaLoading.classList.add('hidden');
            
            // Verificar si hay resultados
            if (enviosFiltrados.length === 0) {
                tbody.innerHTML = '';
                sinResultados.classList.remove('hidden');
                paginacion.classList.add('hidden');
                contador.textContent = '0 env√≠os';
                
                if (esAdmin) {
                    tituloSinResultados.textContent = 'No hay env√≠os con los filtros aplicados';
                    mensajeSinResultados.textContent = 'Intenta con otros criterios de b√∫squeda';
                } else {
                    tituloSinResultados.textContent = 'No tienes env√≠os registrados';
                    mensajeSinResultados.textContent = 'No se encontraron env√≠os con los filtros aplicados';
                }
                
                return;
            }
            
            // Ocultar mensaje sin resultados
            sinResultados.classList.add('hidden');
            
            // Calcular paginaci√≥n
            const totalPaginas = Math.ceil(enviosFiltrados.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = Math.min(inicio + itemsPorPagina, enviosFiltrados.length);
            const enviosPagina = enviosFiltrados.slice(inicio, fin);
            
            // Actualizar controles de paginaci√≥n
            document.getElementById('paginaInicio').textContent = inicio + 1;
            document.getElementById('paginaFin').textContent = fin;
            document.getElementById('totalItems').textContent = enviosFiltrados.length;
            document.getElementById('paginaActual').textContent = `${paginaActual} de ${totalPaginas}`;
            
            document.getElementById('btnAnterior').disabled = paginaActual <= 1;
            document.getElementById('btnSiguiente').disabled = paginaActual >= totalPaginas;
            
            // Mostrar paginaci√≥n si hay m√°s de una p√°gina
            if (totalPaginas > 1) {
                paginacion.classList.remove('hidden');
            } else {
                paginacion.classList.add('hidden');
            }
            
            // Generar filas de la tabla
            let html = '';
            enviosPagina.forEach((envio, index) => {
                const fecha = parsearFechaEnvio(envio["FECHA DE CREACION"]) || new Date();
                const fechaFormateada = fecha.toLocaleDateString('es-CO', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                // Forma de pago
                let formaPagoTexto = '';
                const formaPago = envio["FORMA DE PAGO"] || '';
                switch(formaPago.toLowerCase()) {
                    case 'contado': formaPagoTexto = 'Contado'; break;
                    case 'contraentrega': formaPagoTexto = 'Contraentrega'; break;
                    case 'contraentrega_recaudo': 
                    case 'con recaudo':
                        formaPagoTexto = 'Con Recaudo'; 
                        break;
                    default: formaPagoTexto = formaPago || 'N/A';
                }
                
                // Estado de pago
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                const valorRecaudar = envio.valorRecaudar || 0;
                const totalPagar = envio.totalPagar || 0;
                
                let estadoHTML = '';
                let estadoClase = '';
                
                if (estaPagado) {
                    estadoHTML = 'Pagado';
                    estadoClase = 'badge-pagado';
                } else if (totalPagar > 0) {
                    estadoHTML = 'Pendiente';
                    estadoClase = 'badge-pendiente';
                } else {
                    estadoHTML = 'Sin pago';
                    estadoClase = 'badge-sin-pago';
                }
                
                // ID del env√≠o
                const envioId = (envio["ENVIO ID"] || '').replace(/'/g, "\\'");
                
                if (esAdmin) {
                    html += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="py-3 px-4">
                                <span class="font-mono font-bold text-sm">${envio["ENVIO ID"] || ''}</span>
                            </td>
                            <td class="py-3 px-4 text-sm">${fechaFormateada}</td>
                            <td class="py-3 px-4">
                                <div class="font-medium text-sm">${envio["USUARIO ID"] || ''}</div>
                            </td>
                            <td class="py-3 px-4">
                                <div class="font-medium">${envio["DESTINO"] || ''}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${envio["BARRIO"] || ''}</div>
                            </td>
                            <td class="py-3 px-4 text-sm">${formaPagoTexto}</td>
                            <td class="py-3 px-4 font-medium text-blue-600 dark:text-blue-400">
                                $${valorRecaudar.toLocaleString('es-CO')}
                            </td>
                            <td class="py-3 px-4 font-bold text-green-600 dark:text-green-400">
                                $${totalPagar.toLocaleString('es-CO')}
                            </td>
                            <td class="py-3 px-4 text-sm">
                                ${envio["MENSAJERO"] || 'Sin asignar'}
                            </td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoClase}">
                                    ${estadoHTML}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="verDetalles('${envioId}')" 
                                        class="px-3 py-1 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm flex items-center gap-1 transition-colors">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                    Ver
                                </button>
                            </td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="py-3 px-4">
                                <span class="font-mono font-bold text-sm">${envio["ENVIO ID"] || ''}</span>
                            </td>
                            <td class="py-3 px-4 text-sm">${fechaFormateada}</td>
                            <td class="py-3 px-4">
                                <div class="font-medium">${envio["DESTINO"] || ''}</div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">${envio["BARRIO"] || ''}</div>
                            </td>
                            <td class="py-3 px-4 text-sm">${formaPagoTexto}</td>
                            <td class="py-3 px-4 font-medium text-blue-600 dark:text-blue-400">
                                $${valorRecaudar.toLocaleString('es-CO')}
                            </td>
                            <td class="py-3 px-4 font-bold text-green-600 dark:text-green-400">
                                $${totalPagar.toLocaleString('es-CO')}
                            </td>
                            <td class="py-3 px-4 text-sm">
                                ${envio["MENSAJERO"] || 'Sin asignar'}
                            </td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${estadoClase}">
                                    ${estadoHTML}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="verDetalles('${envioId}')" 
                                        class="px-3 py-1 bg-primary hover:bg-primary-dark text-white rounded-lg text-sm flex items-center gap-1 transition-colors">
                                    <span class="material-symbols-outlined text-sm">visibility</span>
                                    Ver
                                </button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html;
            contador.textContent = `${enviosFiltrados.length} env√≠os`;
        }
        
        function cambiarPagina(direccion) {
            const totalPaginas = Math.ceil(enviosFiltrados.length / itemsPorPagina);
            const nuevaPagina = paginaActual + direccion;
            
            if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
                paginaActual = nuevaPagina;
                mostrarPagina();
                
                // Scroll suave al inicio de la tabla
                document.querySelector('#tablaEnvios').closest('div').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        }
        
        function verDetalles(envioId) {
            const envio = todosEnvios.find(e => e["ENVIO ID"] === envioId);
            
            if (!envio) {
                mostrarError('No se encontraron detalles del env√≠o');
                return;
            }
            
            const fecha = parsearFechaEnvio(envio["FECHA DE CREACION"]) || new Date();
            const fechaFormateada = fecha.toLocaleString('es-CO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Forma de pago
            let formaPagoTexto = '';
            const formaPago = envio["FORMA DE PAGO"] || '';
            switch(formaPago.toLowerCase()) {
                case 'contado': formaPagoTexto = 'Contado'; break;
                case 'contraentrega': formaPagoTexto = 'Contraentrega'; break;
                case 'contraentrega_recaudo': 
                case 'con recaudo':
                    formaPagoTexto = 'Con Recaudo'; 
                    break;
                default: formaPagoTexto = formaPago || 'N/A';
            }
            
            // Estado de pago
            const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
            const estadoPagoTexto = estaPagado ? 'Pagado' : 'Pendiente';
            const estadoPagoColor = estaPagado ? 'text-green-600' : 'text-yellow-600';
            
            let html = `
                <div class="space-y-4">
                    <!-- Encabezado -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
                            <div>
                                <div class="font-bold text-lg mb-1">ID: ${envio["ENVIO ID"] || ''}</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    <span class="material-symbols-outlined align-text-bottom text-sm">schedule</span>
                                    Registrado: ${fechaFormateada}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg text-green-600">$${(envio.totalPagar || 0).toLocaleString('es-CO')}</div>
                                <div class="text-sm text-gray-500">Total a Pagar</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Informaci√≥n del Usuario -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">person</span>
                                Informaci√≥n del ${esAdmin ? 'Usuario' : 'Remitente'}
                            </h4>
                            <div class="space-y-2 text-sm">
                                ${esAdmin ? `<p><span class="font-medium">Usuario ID:</span> ${envio["USUARIO ID"] || ''}</p>` : ''}
                                <p><span class="font-medium">Remitente:</span> ${envio["REMITE"] || ''}</p>
                                <p><span class="font-medium">Tel√©fono:</span> ${envio["TELEFONO"] || ''}</p>
                                <p><span class="font-medium">Correo:</span> ${envio["CORREO REMITENTE"] || ''}</p>
                                <p><span class="font-medium">Direcci√≥n:</span> ${envio["DIRECCION"] || ''}</p>
                            </div>
                        </div>
                        
                        <!-- Destinatario -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">location_on</span>
                                Destinatario
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Nombre:</span> ${envio["DESTINO"] || ''}</p>
                                <p><span class="font-medium">Tel√©fono:</span> ${envio["TELEFONOCLIENTE"] || ''}</p>
                                <p><span class="font-medium">Direcci√≥n:</span> ${envio["DIRECCION DESTINO"] || ''}</p>
                                <p><span class="font-medium">Barrio:</span> ${envio["BARRIO"] || ''}</p>
                                <p><span class="font-medium">Ciudad:</span> ${envio["CIUDAD DESTINO"] || ''}</p>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n de Pago -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">payments</span>
                                Informaci√≥n de Pago
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Forma de pago:</span> ${formaPagoTexto}</p>
                                <p><span class="font-medium">Valor a recaudar:</span> $${(envio.valorRecaudar || 0).toLocaleString('es-CO')}</p>
                                <p><span class="font-medium">Total a pagar:</span> <span class="font-bold text-green-600">$${(envio.totalPagar || 0).toLocaleString('es-CO')}</span></p>
                                <p><span class="font-medium">Estado pago:</span> <span class="font-bold ${estadoPagoColor}">${estadoPagoTexto}</span></p>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n Log√≠stica -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
                            <h4 class="font-bold mb-3 text-primary flex items-center gap-2">
                                <span class="material-symbols-outlined">local_shipping</span>
                                Informaci√≥n Log√≠stica
                            </h4>
                            <div class="space-y-2 text-sm">
                                <p><span class="font-medium">Mensajero:</span> ${envio["MENSAJERO"] || 'Por asignar'}</p>
                                <p><span class="font-medium">Observaciones:</span> ${envio["OBS"] || ''}</p>
                                <p><span class="font-medium">Localidad:</span> ${envio["LOCALIDAD"] || ''}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex flex-wrap gap-2">
                        <button onclick="imprimirGuia('${envio["ENVIO ID"] || ''}')" 
                                class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-symbols-outlined">print</span>
                            Imprimir Gu√≠a
                        </button>
                        <button onclick="copiarEnlace('${envio["ENVIO ID"] || ''}')" 
                                class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-symbols-outlined">link</span>
                            Copiar Enlace
                        </button>
                        <button onclick="cerrarModalDetalles()" 
                                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('modalDetallesContenido').innerHTML = html;
            document.getElementById('modalDetalles').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function cerrarModalDetalles() {
            document.getElementById('modalDetalles').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        function imprimirGuia(envioId) {
            try {
                localStorage.setItem('envioParaGuia', envioId);
                window.open('guia.html', '_blank');
                mostrarToast('success', 'Imprimir', 'Abriendo gu√≠a para imprimir...');
            } catch (error) {
                mostrarToast('error', 'Error', 'No se pudo abrir la gu√≠a');
            }
        }
        
        function copiarEnlace(envioId) {
            const url = `${window.location.origin}${window.location.pathname}?envio=${envioId}`;
            navigator.clipboard.writeText(url).then(() => {
                mostrarToast('success', 'Enlace copiado', 'El enlace se copi√≥ al portapapeles');
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                mostrarToast('success', 'Enlace copiado', 'El enlace se copi√≥ al portapapeles');
            });
        }
        
        function exportarExcel() {
            if (!esAdmin || enviosFiltrados.length === 0) return;
            
            let csv = 'ID,Fecha,Usuario,Destinatario,Barrio,Forma Pago,Valor a Recaudar,Total a Pagar,Estado,Mensajero,Ciudad Destino\n';
            
            enviosFiltrados.forEach(envio => {
                const fecha = parsearFechaEnvio(envio["FECHA DE CREACION"]) || new Date();
                const fechaFormateada = fecha.toLocaleDateString('es-CO');
                const estaPagado = determinarSiEstaPagado(envio["PAGADO A REMITENTE"]);
                const estado = estaPagado ? 'Pagado' : 'Pendiente';
                
                csv += `"${envio["ENVIO ID"] || ''}","${fechaFormateada}","${envio["USUARIO ID"] || ''}","${envio["DESTINO"] || ''}","${envio["BARRIO"] || ''}","${envio["FORMA DE PAGO"] || ''}","${envio.valorRecaudar || 0}","${envio.totalPagar || 0}","${estado}","${envio["MENSAJERO"] || ''}","${envio["CIUDAD DESTINO"] || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const fechaExportacion = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `envios_${fechaExportacion}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarToast('success', 'Exportaci√≥n exitosa', 'El archivo CSV se ha descargado');
        }
        
        function mostrarToast(tipo, titulo, mensaje) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toastIcon');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            let icono = 'info';
            let color = 'text-blue-500';
            
            switch(tipo) {
                case 'success':
                    icono = 'check_circle';
                    color = 'text-green-500';
                    break;
                case 'error':
                    icono = 'error';
                    color = 'text-red-500';
                    break;
                case 'warning':
                    icono = 'warning';
                    color = 'text-yellow-500';
                    break;
                default:
                    icono = 'info';
                    color = 'text-blue-500';
            }
            
            toastIcon.textContent = icono;
            toastIcon.className = `material-symbols-outlined mr-3 ${color}`;
            toastTitle.textContent = titulo;
            toastMessage.textContent = mensaje;
            
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                cerrarToast();
            }, 5000);
        }
        
        function cerrarToast() {
            document.getElementById('toast').classList.add('hidden');
        }
        
        function mostrarError(mensaje) {
            mostrarToast('error', 'Error', mensaje);
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
